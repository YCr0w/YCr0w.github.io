<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="YCr0w"><meta name="copyright" content="YCr0w"><meta name="generator" content="Hexo 7.3.0"><meta name="theme" content="hexo-theme-yun"><title>加载特定模块的方法 | YCr0w'blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"example.com","root":"/","title":"要么庸俗，要么孤独","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="使用 Windows API‍ 静态链接 (Static Linking) : 在编译时将 DLL 中的函数链接到可执行文件中。 应用程序在运行时不需要额外加载 DLL。 优点是加载和执行速度快,缺点是可执行文件体积较大。  动态链接 (Dynamic Linking) : 在运行时动态加载 DLL,并调用 DLL 中的函数。 应用程序需要使用 LoadLibrary​ 和 GetProcAddr">
<meta property="og:type" content="article">
<meta property="og:title" content="加载特定模块的方法">
<meta property="og:url" content="http://example.com/2024/08/07/%E5%8A%A0%E8%BD%BD%E7%89%B9%E5%AE%9A%E6%A8%A1%E5%9D%97%E7%9A%84%E6%96%B9%E6%B3%95/index.html">
<meta property="og:site_name" content="YCr0w&#39;blog">
<meta property="og:description" content="使用 Windows API‍ 静态链接 (Static Linking) : 在编译时将 DLL 中的函数链接到可执行文件中。 应用程序在运行时不需要额外加载 DLL。 优点是加载和执行速度快,缺点是可执行文件体积较大。  动态链接 (Dynamic Linking) : 在运行时动态加载 DLL,并调用 DLL 中的函数。 应用程序需要使用 LoadLibrary​ 和 GetProcAddr">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/imge/dll%E5%8A%A0%E8%BD%BD/assets/image-20240807220505-gos0xhf.png">
<meta property="article:published_time" content="2024-08-07T14:19:05.000Z">
<meta property="article:modified_time" content="2024-08-07T14:21:12.901Z">
<meta property="article:author" content="YCr0w">
<meta property="article:tag" content="学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imge/dll%E5%8A%A0%E8%BD%BD/assets/image-20240807220505-gos0xhf.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="YCr0w"><img width="96" loading="lazy" src="/yun.png" alt="YCr0w"><span class="site-author-status">^_^</span></a><div class="site-author-name"><a href="/about/">YCr0w</a></div><a class="site-name" href="/about/site.html">YCr0w'blog</a><sub class="site-subtitle">逆风而行</sub><div class="site-description">找到美的真正所在：不断前行，不要舍弃梦想。</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">6</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">0</span></a></div><a class="site-state-item hty-icon-button" href="/"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:quill-pen-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YCr0w" title="GitHub" target="_blank" style="color:#181717"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:3083981460@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Windows-API"><span class="toc-number">1.</span> <span class="toc-text">使用 Windows API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5-Static-Linking"><span class="toc-number">1.0.1.</span> <span class="toc-text">静态链接 (Static Linking) :</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5-Dynamic-Linking"><span class="toc-number">1.0.2.</span> <span class="toc-text">动态链接 (Dynamic Linking) :</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%90%E5%BC%8F%E9%93%BE%E6%8E%A5-Implicit-Linking"><span class="toc-number">1.0.3.</span> <span class="toc-text">隐式链接 (Implicit Linking) :</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E5%BC%8F%E9%93%BE%E6%8E%A5-Explicit-Linking"><span class="toc-number">1.0.4.</span> <span class="toc-text">显式链接 (Explicit Linking) :</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8win-api%E5%87%BD%E6%95%B0%EF%BC%88%E5%88%97%E4%B8%BE%E4%BA%86%E4%B8%A4%E7%A7%8D%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">常用win api函数（列举了两种）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%8BLoadLibraryEx%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">​LoadLibraryEx​函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%8BVirtualQueryEx-%E2%80%8B-%E5%92%8C-ReadProcessMemory-%E2%80%8B-%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">​VirtualQueryEx()​ 和 ReadProcessMemory()​ 函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#win-api%E8%B0%83%E7%94%A8dll%E7%9A%84%E4%BC%98-%E7%BC%BA%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">win api调用dll的优\缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%81%8D%E5%8E%86-PEB-%E7%9A%84%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.</span> <span class="toc-text">使用遍历 PEB 的模块链表加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86-PEB%E7%9A%84%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8%E5%8A%A0%E8%BD%BD-DLL-%E7%9A%84%E8%AF%A6%E7%BB%86%E8%BF%87%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">遍历 PEB的模块链表加载 DLL 的详细过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96PEB%E5%9C%B0%E5%9D%80"><span class="toc-number">2.1.1.</span> <span class="toc-text">获取PEB地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">遍历模块链表:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-DLL-%E7%9A%84%E5%9F%BA%E5%9C%B0%E5%9D%80%E5%92%8C%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-number">2.1.3.</span> <span class="toc-text">获取 DLL 的基地址和入口点:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86-PEB-%E7%9A%84%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8%E5%8A%A0%E8%BD%BDdll%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">2.2.</span> <span class="toc-text">遍历 PEB 的模块链表加载dll的优缺点</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://example.com/2024/08/07/%E5%8A%A0%E8%BD%BD%E7%89%B9%E5%AE%9A%E6%A8%A1%E5%9D%97%E7%9A%84%E6%96%B9%E6%B3%95/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="YCr0w"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="YCr0w'blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">加载特定模块的方法</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2024-08-07 22:19:05" itemprop="dateCreated datePublished" datetime="2024-08-07T22:19:05+08:00">2024-08-07</time></div><div class="post-classify"></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="使用-Windows-API"><a href="#使用-Windows-API" class="headerlink" title="使用 Windows API"></a>使用 Windows API</h2><p>‍</p>
<h4 id="静态链接-Static-Linking"><a href="#静态链接-Static-Linking" class="headerlink" title="静态链接 (Static Linking) :"></a><strong>静态链接 (Static Linking)</strong> :</h4><ul>
<li>在编译时将 DLL 中的函数链接到可执行文件中。</li>
<li>应用程序在运行时不需要额外加载 DLL。</li>
<li>优点是加载和执行速度快,缺点是可执行文件体积较大。</li>
</ul>
<h4 id="动态链接-Dynamic-Linking"><a href="#动态链接-Dynamic-Linking" class="headerlink" title="动态链接 (Dynamic Linking) :"></a><strong>动态链接 (Dynamic Linking)</strong> :</h4><ul>
<li>在运行时动态加载 DLL,并调用 DLL 中的函数。</li>
<li>应用程序需要使用 <code>LoadLibrary</code>​ 和 <code>GetProcAddress</code>​ 等 Windows API 函数来加载和访问 DLL 中的函数。</li>
<li>优点是可执行文件体积较小,缺点是加载和执行速度稍慢,并且需要确保 DLL 文件在运行时可用。</li>
</ul>
<h4 id="隐式链接-Implicit-Linking"><a href="#隐式链接-Implicit-Linking" class="headerlink" title="隐式链接 (Implicit Linking) :"></a><strong><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/build/linking-an-executable-to-a-dll?view=msvc-170#:~:text=%E5%90%84%E6%9C%89%E4%BC%98%E7%BC%BA%E7%82%B9%E3%80%82-,%E9%9A%90%E5%BC%8F%E9%93%BE%E6%8E%A5,-%E5%BD%93%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F">隐式链接 (Implicit Linking)</a></strong> :</h4><ul>
<li>在编译时使用 <code>#include</code>​ 或 <code>#pragma comment</code>​ 指令,将 DLL 中的函数声明添加到应用程序的源代码中。</li>
<li>编译器会自动生成调用 DLL 函数的代码,并在链接时将其链接到可执行文件中。</li>
<li>这种方式对开发人员来说更加简单和方便,但缺点是可执行文件体积较大。</li>
</ul>
<h4 id="显式链接-Explicit-Linking"><a href="#显式链接-Explicit-Linking" class="headerlink" title="显式链接 (Explicit Linking) :"></a><strong><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/build/linking-an-executable-to-a-dll?view=msvc-170#:~:text=%E4%B8%8D%E5%86%8D%E6%9C%89%E6%84%8F%E4%B9%89%E3%80%82-,%E6%98%BE%E5%BC%8F%E9%93%BE%E6%8E%A5,-%E5%A4%A7%E5%A4%9A%E6%95%B0%E5%BA%94%E7%94%A8">显式链接 (Explicit Linking)</a></strong> :</h4><ul>
<li>在运行时使用 <code>LoadLibrary</code>​ 和 <code>GetProcAddress</code>​ 等 Windows API 函数动态加载 DLL,并调用 DLL 中的函数。</li>
<li>这种方式给开发人员更多的灵活性和控制权,但需要编写更多的代码。</li>
</ul>
<p>‍</p>
<h3 id="常用win-api函数（列举了两种）"><a href="#常用win-api函数（列举了两种）" class="headerlink" title="常用win api函数（列举了两种）"></a>常用win api函数（列举了两种）</h3><h4 id="​LoadLibraryEx​函数"><a href="#​LoadLibraryEx​函数" class="headerlink" title="​LoadLibraryEx​函数"></a>​<code>LoadLibraryEx</code>​函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HMODULE <span class="title function_">LoadLibraryEx</span><span class="params">(</span></span><br><span class="line"><span class="params">    LPCTSTR lpLibFileName,</span></span><br><span class="line"><span class="params">    HANDLE hFile,</span></span><br><span class="line"><span class="params">    DWORD dwFlags</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>参数说明:</p>
<ol>
<li><p>​<code>lpLibFileName</code>​: 要加载的 DLL 文件的完整路径。</p>
</li>
<li><p>​<code>hFile</code>​: 可选参数,用于指定加载 DLL 的文件句柄。通常设置为 <code>NULL</code>​。</p>
</li>
<li><p>​<code>dwFlags</code>​: 用于指定加载 DLL 的行为方式,可以是以下值的组合:</p>
<ul>
<li>​<code>LOAD_LIBRARY_AS_DATAFILE</code>​: 以数据文件的方式加载 DLL,不执行任何 DLL 初始化代码。</li>
<li>​<code>LOAD_LIBRARY_AS_IMAGE_RESOURCE</code>​: 将 DLL 加载为映像资源,而不是作为可执行模块。</li>
<li>​<code>LOAD_LIBRARY_AS_DATAFILE_EXCLUSIVE</code>​: 以独占方式加载 DLL 为数据文件。</li>
<li>​<code>LOAD_LIBRARY_REQUIRE_SIGNED_TARGET</code>​: 要求目标 DLL 必须是经过数字签名的。</li>
<li>​<code>LOAD_LIBRARY_SEARCH_APPLICATION_DIR</code>​: 在应用程序目录中搜索 DLL。</li>
<li>​<code>LOAD_LIBRARY_SEARCH_DEFAULT_DIRS</code>​: 在默认的搜索目录中搜索 DLL。</li>
<li>等等。</li>
</ul>
</li>
</ol>
<p>函数返回值:</p>
<ul>
<li>成功返回加载的 DLL 模块句柄(HMODULE)。</li>
<li>失败返回 <code>NULL</code>​。可以通过 <code>GetLastError()</code>​ 函数获取错误代码。</li>
</ul>
<p>进程调用 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryw">LoadLibrary</a> 或 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryexw">LoadLibraryEx</a> 以显式链接到 DLL。如果函数执行成功，它会将指定的 DLL 映射到调用进程的地址空间中并返回该 DLL 的句柄。 此句柄可以与其他函数（如 <code>GetProcAddress</code>​ 和 <code>FreeLibrary</code>​）一起在<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/build/linking-an-executable-to-a-dll?view=msvc-170#linking-explicitly:~:text=DLL%20%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E3%80%82-,%E5%A6%82%E4%BD%95%E6%98%BE%E5%BC%8F%E9%93%BE%E6%8E%A5%E5%88%B0%20DLL,-%E8%8B%A5%E8%A6%81%E9%80%9A%E8%BF%87%E6%98%BE">显式链接</a>中使用。</p>
<p>‍</p>
<p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*MYFUNCTION)</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 加载 DLL</span></span><br><span class="line">    HMODULE hModule = LoadLibraryEx(<span class="string">L&quot;MyDLL.dll&quot;</span>, <span class="literal">NULL</span>, LOAD_WITH_ALTERED_SEARCH_PATH);</span><br><span class="line">    <span class="keyword">if</span> (hModule == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LoadLibraryEx failed, error code: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 DLL 中的函数地址</span></span><br><span class="line">    MYFUNCTION myFunction = (MYFUNCTION)GetProcAddress(hModule, <span class="string">&quot;MyFunction&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (myFunction == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;GetProcAddress failed, error code: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        FreeLibrary(hModule);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 DLL 中的函数</span></span><br><span class="line">    <span class="type">int</span> result = myFunction(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;MyFunction result: %d\n&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放 DLL</span></span><br><span class="line">    FreeLibrary(hModule);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用了 <code>LoadLibraryEx()</code>​ 函数来加载 <code>MyDLL.dll</code>​ 文件；加载成功后,使用 <code>GetProcAddress()</code>​ 函数获取 DLL 中 <code>MyFunction</code>​ 函数的地址,并将其转换为我们自定义的 <code>MYFUNCTION</code>​ 类型的函数指针。</p>
<p>最后,调用 <code>MyFunction()</code>​ 并打印结果,然后使用 <code>FreeLibrary()</code>​ 函数释放 DLL。</p>
<p>‍</p>
<h4 id="​VirtualQueryEx-​-和-ReadProcessMemory-​-函数"><a href="#​VirtualQueryEx-​-和-ReadProcessMemory-​-函数" class="headerlink" title="​VirtualQueryEx()​ 和 ReadProcessMemory()​ 函数"></a>​<code>VirtualQueryEx()</code>​ 和 <code>ReadProcessMemory()</code>​ 函数</h4><p>​<code>VirtualQueryEx()</code>​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SIZE_T <span class="title function_">VirtualQueryEx</span><span class="params">(</span></span><br><span class="line"><span class="params">  HANDLE                    hProcess,</span></span><br><span class="line"><span class="params">  LPCVOID                   lpAddress,</span></span><br><span class="line"><span class="params">  PMEMORY_BASIC_INFORMATION lpBuffer,</span></span><br><span class="line"><span class="params">  SIZE_T                    dwLength</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>作用:</p>
<ul>
<li>查询指定进程中某个虚拟地址范围的内存基本信息,如内存状态、保护属性、分配类型等。</li>
</ul>
</li>
<li><p>参数:</p>
<ul>
<li>​<code>hProcess</code>​: 要查询的进程句柄。</li>
<li>​<code>lpAddress</code>​: 要查询的虚拟地址。</li>
<li>​<code>lpBuffer</code>​: 指向 <code>MEMORY_BASIC_INFORMATION</code>​ 结构体的指针,用于接收查询结果。</li>
<li>​<code>dwLength</code>​: <code>lpBuffer</code>​ 结构体的大小。</li>
</ul>
</li>
<li><p>返回值:</p>
<ul>
<li>成功时返回 <code>lpBuffer</code>​ 中填充的字节数。</li>
<li>失败时返回 0,可以通过 <code>GetLastError()</code>​ 获取错误代码。</li>
</ul>
</li>
</ul>
<p>‍</p>
<p>​<code>ReadProcessMemory()</code>​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">ReadProcessMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">  HANDLE  hProcess,</span></span><br><span class="line"><span class="params">  LPCVOID lpBaseAddress,</span></span><br><span class="line"><span class="params">  LPVOID  lpBuffer,</span></span><br><span class="line"><span class="params">  SIZE_T  nSize,</span></span><br><span class="line"><span class="params">  SIZE_T *lpNumberOfBytesRead</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>作用:</p>
<ul>
<li>从指定进程的虚拟地址空间中读取数据。</li>
</ul>
</li>
<li><p>参数:</p>
<ul>
<li>​<code>hProcess</code>​: 要读取的进程句柄。</li>
<li>​<code>lpBaseAddress</code>​: 要读取的虚拟地址。</li>
<li>​<code>lpBuffer</code>​: 指向接收读取数据的缓冲区。</li>
<li>​<code>nSize</code>​: 要读取的字节数。</li>
<li>​<code>lpNumberOfBytesRead</code>​: 指针,用于接收实际读取的字节数。</li>
</ul>
</li>
<li><p>返回值:</p>
<ul>
<li>成功时返回 <code>TRUE</code>​。</li>
<li>失败时返回 <code>FALSE</code>​,可以通过 <code>GetLastError()</code>​ 获取错误代码。</li>
</ul>
</li>
</ul>
<p>‍</p>
<p>加载dll示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 DLL 的结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DLL_INFO</span> &#123;</span></span><br><span class="line">    DWORD Magic;</span><br><span class="line">    DWORD Version;</span><br><span class="line">    DWORD Reserved[<span class="number">2</span>];</span><br><span class="line">&#125; DLL_INFO, *PDLL_INFO;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HANDLE hProcess = OpenProcess(PROCESS_QUERY_INFORMATION | PROCESS_VM_READ, FALSE, GetCurrentProcessId());</span><br><span class="line">    <span class="keyword">if</span> (hProcess == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcess failed, error code: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 VirtualQueryEx() 查找 DLL 的基地址</span></span><br><span class="line">    MEMORY_BASIC_INFORMATION mbi;</span><br><span class="line">    PVOID baseAddress = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span> (VirtualQueryEx(hProcess, baseAddress, &amp;mbi, <span class="keyword">sizeof</span>(mbi)) == <span class="keyword">sizeof</span>(mbi))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mbi.Type == MEM_IMAGE &amp;&amp; (mbi.Protect &amp; PAGE_EXECUTE_READ))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 找到一个可执行的内存区域,检查是否是 DLL </span></span><br><span class="line">            DWORD_PTR moduleBase = (DWORD_PTR)mbi.BaseAddress;</span><br><span class="line">            PDLL_INFO dllInfo = (PDLL_INFO)moduleBase;</span><br><span class="line">            <span class="keyword">if</span> (dllInfo-&gt;Magic == <span class="number">0x00000000</span> &amp;&amp; dllInfo-&gt;Version == <span class="number">0x00010000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 找到 DLL 的基地址</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;DLL found at address: %p\n&quot;</span>, (PVOID)moduleBase);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        baseAddress = (PVOID)((DWORD_PTR)mbi.BaseAddress + mbi.RegionSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (baseAddress == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;DLL not found in the process.\n&quot;</span>);</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 ReadProcessMemory() 读取 DLL 的信息</span></span><br><span class="line">    DLL_INFO dllInfo;</span><br><span class="line">    <span class="keyword">if</span> (!ReadProcessMemory(hProcess, baseAddress, &amp;dllInfo, <span class="keyword">sizeof</span>(dllInfo), <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadProcessMemory failed, error code: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DLL Magic: 0x%08X\n&quot;</span>, dllInfo.Magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DLL Version: 0x%08X\n&quot;</span>, dllInfo.Version);</span><br><span class="line"></span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用 <code>VirtualQueryEx()</code>​ 函数来查找进程中可执行的内存区域,并检查是否存在 DLL 的标志信息。一旦找到 DLL 的基地址,我们就使用 <code>ReadProcessMemory()</code>​ 函数来读取 DLL 的头部信息。</p>
<p>‍</p>
<h3 id="win-api调用dll的优-缺点"><a href="#win-api调用dll的优-缺点" class="headerlink" title="win api调用dll的优\缺点"></a>win api调用dll的优\缺点</h3><p>优：</p>
<ul>
<li>使用简单,API 函数如 <code>LoadLibrary</code>​ 和 <code>GetProcAddress</code>​ 易于使用。</li>
<li>可以实现动态和静态链接两种方式,提供更多的灵活性。</li>
<li>可以在运行时检查 DLL 是否已经被加载,避免重复加载。</li>
</ul>
<p>缺：</p>
<ul>
<li>需要手动编写加载和卸载 DLL 的代码。</li>
<li>需要处理 DLL 依赖关系和版本兼容性问题。</li>
<li>如果 DLL 文件不存在或无法访问,会导致应用程序崩溃。</li>
</ul>
<p>‍</p>
<p>‍</p>
<p>‍</p>
<h2 id="使用遍历-PEB-的模块链表加载"><a href="#使用遍历-PEB-的模块链表加载" class="headerlink" title="使用遍历 PEB 的模块链表加载"></a>使用遍历 PEB 的模块链表加载</h2><p>通过PEB来遍历进程模块没有Win API的使用痕迹，在某些场合更加好用</p>
<h3 id="遍历-PEB的模块链表加载-DLL-的详细过程"><a href="#遍历-PEB的模块链表加载-DLL-的详细过程" class="headerlink" title="遍历 PEB的模块链表加载 DLL 的详细过程"></a>遍历 PEB的模块链表加载 DLL 的详细过程</h3><h4 id="获取PEB地址"><a href="#获取PEB地址" class="headerlink" title="获取PEB地址"></a>获取PEB地址</h4><p>32位应用程序的 PEB 的地址可以通过 fs:[0x30]获取，fs:[0]为TEB结构的地址</p>
<p>在 64 位 Windows 上, TEB 地址存储在 <code>gs:0x30</code>​ 寄存器中PEB 地址存储在 TEB 结构的 <code>0x60</code>​ 偏移处。因此, 可以通过先获取 TEB 地址, 然后读取 <code>0x60</code>​ 偏移处的值来获取 PEB 地址。</p>
<p>‍</p>
<h4 id="遍历模块链表"><a href="#遍历模块链表" class="headerlink" title="遍历模块链表:"></a><strong>遍历模块链表</strong>:</h4><p>PEB 中包含一个指向模块列表头部的指针, 通过遍历这个模块链表, 可以获取到进程中加载的所有模块(包括 DLL)的信息。</p>
<p>每个模块在链表中都由一个 <code>LDR_DATA_TABLE_ENTRY</code>​ 结构体来表示, 其中包含了模块的文件路径、基地址、入口点等信息。</p>
<p>‍</p>
<h4 id="获取-DLL-的基地址和入口点"><a href="#获取-DLL-的基地址和入口点" class="headerlink" title="获取 DLL 的基地址和入口点:"></a><strong>获取 DLL 的基地址和入口点</strong>:</h4><p>遍历模块链表时, 可以根据 DLL 的文件名或路径, 找到对应的 <code>LDR_DATA_TABLE_ENTRY</code>​ 结构体, 从中获取 DLL 的基地址和入口点地址。</p>
<p>‍</p>
<p>‍</p>
<p>TEB结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TEB 结构体定义</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TEB</span> &#123;</span></span><br><span class="line">    NT_TIB            NtTib;                           <span class="comment">// 0x000</span></span><br><span class="line">    PVOID             EnvironmentPointer;             <span class="comment">// 0x038</span></span><br><span class="line">    CLIENT_ID         ClientId;                        <span class="comment">// 0x040</span></span><br><span class="line">    PVOID             ActiveRpcHandle;                <span class="comment">// 0x050</span></span><br><span class="line">    PVOID             ThreadLocalStoragePointer;      <span class="comment">// 0x058</span></span><br><span class="line">    PEB*              ProcessEnvironmentBlock;        <span class="comment">// 0x060 √</span></span><br><span class="line">    ULONG            LastErrorValue;                 <span class="comment">// 0x068</span></span><br><span class="line">    ULONG            CountOfOwnedCriticalSections;   <span class="comment">// 0x06C</span></span><br><span class="line">    PVOID             CsrClientThread;                <span class="comment">// 0x070</span></span><br><span class="line">    PVOID             Win32ThreadInfo;                <span class="comment">// 0x078</span></span><br><span class="line">    ULONG            User32Reserved[<span class="number">26</span>];             <span class="comment">// 0x080</span></span><br><span class="line">    ULONG            UserReserved[<span class="number">5</span>];                <span class="comment">// 0x0E8</span></span><br><span class="line">    PVOID             WOW32Reserved;                  <span class="comment">// 0x100</span></span><br><span class="line">    LCID              CurrentLocale;                  <span class="comment">// 0x108</span></span><br><span class="line">    ULONG            FpSoftwareStatusRegister;       <span class="comment">// 0x10C</span></span><br><span class="line">    PVOID             SystemReserved1[<span class="number">54</span>];            <span class="comment">// 0x110</span></span><br><span class="line">    NTSTATUS          ExceptionCode;                  <span class="comment">// 0x200</span></span><br><span class="line">    PVOID             ActivationContextStackPointer; <span class="comment">// 0x204</span></span><br><span class="line">    UCHAR             SpareBytes[<span class="number">36</span>];                 <span class="comment">// 0x208</span></span><br><span class="line">    ULONG            TxFsContext;                    <span class="comment">// 0x22C</span></span><br><span class="line">    PIO_EXCEPTION_BLOCK IoSb;                        <span class="comment">// 0x230</span></span><br><span class="line">    ULONG            IosbInfo;                       <span class="comment">// 0x238</span></span><br><span class="line">    PVOID             WaitingOnLoaderLock;           <span class="comment">// 0x23C</span></span><br><span class="line">    PVOID             RequestedIrql;                 <span class="comment">// 0x240</span></span><br><span class="line">    PVOID             CantBlock;                     <span class="comment">// 0x244</span></span><br><span class="line">    ULONG            CantBlockCounter;               <span class="comment">// 0x248</span></span><br><span class="line">    PVOID             FadingFunction;                <span class="comment">// 0x24C</span></span><br><span class="line">    ULONG            FadingCounter;                  <span class="comment">// 0x250</span></span><br><span class="line">    PVOID             IdealProcessor;                <span class="comment">// 0x254</span></span><br><span class="line">    ULONG            GuaranteedStackBytes;          <span class="comment">// 0x258</span></span><br><span class="line">    PVOID             ReservedForPerf;               <span class="comment">// 0x25C</span></span><br><span class="line">    PVOID             ReservedForOle;                <span class="comment">// 0x260</span></span><br><span class="line">    ULONG            WaitingOnCount;                <span class="comment">// 0x264</span></span><br><span class="line">    ULONG            Spare4;                        <span class="comment">// 0x268</span></span><br><span class="line">    PVOID             ReservedForDebugger;          <span class="comment">// 0x26C</span></span><br><span class="line">&#125; TEB, *PTEB;</span><br></pre></td></tr></table></figure>

<p>TEB结构的偏移0x60就是PEB结构</p>
<p>PEB结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span> &#123;</span></span><br><span class="line">    BOOLEAN InheritedAddressSpace;                <span class="comment">// Offset: 0x00</span></span><br><span class="line">    BOOLEAN ReadImageFileExecOptions;            <span class="comment">// Offset: 0x01</span></span><br><span class="line">    BOOLEAN BeingDebugged;                       <span class="comment">// Offset: 0x02</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        BOOLEAN BitField;                        <span class="comment">// Offset: 0x03</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            BOOLEAN ImageUsesLargePages : <span class="number">1</span>;     <span class="comment">// Offset: 0x03</span></span><br><span class="line">            BOOLEAN IsProtectedProcess : <span class="number">1</span>;      <span class="comment">// Offset: 0x03</span></span><br><span class="line">            BOOLEAN IsImageDynamicallyRelocated : <span class="number">1</span>; <span class="comment">// Offset: 0x03</span></span><br><span class="line">            BOOLEAN SkipPatchingUser32Forwarders : <span class="number">1</span>; <span class="comment">// Offset: 0x03</span></span><br><span class="line">            BOOLEAN IsPackagedProcess : <span class="number">1</span>;       <span class="comment">// Offset: 0x03</span></span><br><span class="line">            BOOLEAN IsAppContainer : <span class="number">1</span>;          <span class="comment">// Offset: 0x03</span></span><br><span class="line">            BOOLEAN IsProtectedProcessLight : <span class="number">1</span>; <span class="comment">// Offset: 0x03</span></span><br><span class="line">            BOOLEAN IsLongPathAwareProcess : <span class="number">1</span>;  <span class="comment">// Offset: 0x03</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    HANDLE Mutant;                               <span class="comment">// Offset: 0x08</span></span><br><span class="line">    PVOID ImageBaseAddress;                      <span class="comment">// Offset: 0x10</span></span><br><span class="line">    PPEB_LDR_DATA Ldr;                           <span class="comment">// Offset: 0x18</span></span><br><span class="line">    PVOID ProcessParameters;                     <span class="comment">// Offset: 0x20</span></span><br><span class="line">    PVOID SubSystemData;                         <span class="comment">// Offset: 0x28</span></span><br><span class="line">    PVOID ProcessHeap;                           <span class="comment">// Offset: 0x30</span></span><br><span class="line">    PRTL_CRITICAL_SECTION FastPebLock;           <span class="comment">// Offset: 0x38</span></span><br><span class="line">    PVOID AtlThunkSListPtr;                      <span class="comment">// Offset: 0x40</span></span><br><span class="line">    PVOID IFEOKey;                               <span class="comment">// Offset: 0x48</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        ULONG CrossProcessFlags;                 <span class="comment">// Offset: 0x50</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG ProcessInJob : <span class="number">1</span>;              <span class="comment">// Offset: 0x50</span></span><br><span class="line">            ULONG ProcessInitializing : <span class="number">1</span>;       <span class="comment">// Offset: 0x50</span></span><br><span class="line">            ULONG ProcessUsingVEH : <span class="number">1</span>;           <span class="comment">// Offset: 0x50</span></span><br><span class="line">            ULONG ProcessUsingVCH : <span class="number">1</span>;           <span class="comment">// Offset: 0x50</span></span><br><span class="line">            ULONG ProcessUsingFTH : <span class="number">1</span>;           <span class="comment">// Offset: 0x50</span></span><br><span class="line">            ULONG ReservedBits0 : <span class="number">27</span>;            <span class="comment">// Offset: 0x50</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        PVOID KernelCallbackTable;               <span class="comment">// Offset: 0x54</span></span><br><span class="line">        PVOID UserSharedInfoPtr;                 <span class="comment">// Offset: 0x54</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG SystemReserved;                        <span class="comment">// Offset: 0x58</span></span><br><span class="line">    ULONG AtlThunkSListPtr32;                    <span class="comment">// Offset: 0x5C</span></span><br><span class="line">    PVOID ApiSetMap;                             <span class="comment">// Offset: 0x60</span></span><br><span class="line">    ULONG TlsExpansionCounter;                   <span class="comment">// Offset: 0x68</span></span><br><span class="line">    PVOID TlsBitmap;                             <span class="comment">// Offset: 0x70</span></span><br><span class="line">    ULONG TlsBitmapBits[<span class="number">2</span>];                      <span class="comment">// Offset: 0x78</span></span><br><span class="line">    PVOID ReadOnlySharedMemoryBase;              <span class="comment">// Offset: 0x80</span></span><br><span class="line">    PVOID HotpatchInformation;                   <span class="comment">// Offset: 0x88</span></span><br><span class="line">    PVOID *ReadOnlyStaticServerData;             <span class="comment">// Offset: 0x90</span></span><br><span class="line">    PVOID AnsiCodePageData;                      <span class="comment">// Offset: 0x98</span></span><br><span class="line">    PVOID OemCodePageData;                       <span class="comment">// Offset: 0xA0</span></span><br><span class="line">    PVOID UnicodeCaseTableData;                  <span class="comment">// Offset: 0xA8</span></span><br><span class="line">    ULONG NumberOfProcessors;                    <span class="comment">// Offset: 0xB0</span></span><br><span class="line">    ULONG NtGlobalFlag;                          <span class="comment">// Offset: 0xB4</span></span><br><span class="line">    ULARGE_INTEGER CriticalSectionTimeout;       <span class="comment">// Offset: 0xB8</span></span><br><span class="line">    ULONG HeapSegmentReserve;                    <span class="comment">// Offset: 0xC0</span></span><br><span class="line">    ULONG HeapSegmentCommit;                     <span class="comment">// Offset: 0xC4</span></span><br><span class="line">    ULONG HeapDeCommitTotalFreeThreshold;        <span class="comment">// Offset: 0xC8</span></span><br><span class="line">    ULONG HeapDeCommitFreeBlockThreshold;        <span class="comment">// Offset: 0xCC</span></span><br><span class="line">    ULONG NumberOfHeaps;                         <span class="comment">// Offset: 0xD0</span></span><br><span class="line">    ULONG MaximumNumberOfHeaps;                  <span class="comment">// Offset: 0xD4</span></span><br><span class="line">    PVOID *ProcessHeaps;                         <span class="comment">// Offset: 0xD8</span></span><br><span class="line">    PVOID GdiSharedHandleTable;                  <span class="comment">// Offset: 0xE0</span></span><br><span class="line">    PVOID ProcessStarterHelper;                  <span class="comment">// Offset: 0xE8</span></span><br><span class="line">    ULONG GdiDCAttributeList;                    <span class="comment">// Offset: 0xF0</span></span><br><span class="line">    PVOID LoaderLock;                            <span class="comment">// Offset: 0xF4</span></span><br><span class="line">    ULONG OSMajorVersion;                        <span class="comment">// Offset: 0xF8</span></span><br><span class="line">    ULONG OSMinorVersion;                        <span class="comment">// Offset: 0xFC</span></span><br><span class="line">    USHORT OSBuildNumber;                        <span class="comment">// Offset: 0x100</span></span><br><span class="line">    USHORT OSCSDVersion;                         <span class="comment">// Offset: 0x102</span></span><br><span class="line">    ULONG OSPlatformId;                          <span class="comment">// Offset: 0x104</span></span><br><span class="line">    ULONG ImageSubsystem;                        <span class="comment">// Offset: 0x108</span></span><br><span class="line">    ULONG ImageSubsystemMajorVersion;            <span class="comment">// Offset: 0x10C</span></span><br><span class="line">    ULONG ImageSubsystemMinorVersion;            <span class="comment">// Offset: 0x110</span></span><br><span class="line">    ULONG_PTR ImageProcessAffinityMask;          <span class="comment">// Offset: 0x114</span></span><br><span class="line">    ULONG GdiHandleBuffer[<span class="number">60</span>];                   <span class="comment">// Offset: 0x118</span></span><br><span class="line">    PVOID PostProcessInitRoutine;                <span class="comment">// Offset: 0x2F8</span></span><br><span class="line">    PVOID TlsExpansionBitmap;                    <span class="comment">// Offset: 0x300</span></span><br><span class="line">    ULONG TlsExpansionBitmapBits[<span class="number">32</span>];            <span class="comment">// Offset: 0x308</span></span><br><span class="line">    ULONG SessionId;                             <span class="comment">// Offset: 0x388</span></span><br><span class="line">    ULARGE_INTEGER AppCompatFlags;               <span class="comment">// Offset: 0x390</span></span><br><span class="line">    ULARGE_INTEGER AppCompatFlagsUser;           <span class="comment">// Offset: 0x398</span></span><br><span class="line">    PVOID pShimData;                             <span class="comment">// Offset: 0x3A0</span></span><br><span class="line">    PVOID AppCompatInfo;                         <span class="comment">// Offset: 0x3A8</span></span><br><span class="line">    UNICODE_STRING CSDVersion;                   <span class="comment">// Offset: 0x3B0</span></span><br><span class="line">    PVOID ActivationContextData;                 <span class="comment">// Offset: 0x3C0</span></span><br><span class="line">    PVOID ProcessAssemblyStorageMap;             <span class="comment">// Offset: 0x3C8</span></span><br><span class="line">    PVOID SystemDefaultActivationContextData;    <span class="comment">// Offset: 0x3D0</span></span><br><span class="line">    PVOID SystemAssemblyStorageMap;              <span class="comment">// Offset: 0x3D8</span></span><br><span class="line">    ULONG MinimumStackCommit;                    <span class="comment">// Offset: 0x3E0</span></span><br><span class="line">    PVOID FlsCallback;                           <span class="comment">// Offset: 0x3E8</span></span><br><span class="line">    LIST_ENTRY FlsListHead;                      <span class="comment">// Offset: 0x3F0</span></span><br><span class="line">    PVOID FlsBitmap;                             <span class="comment">// Offset: 0x400</span></span><br><span class="line">    ULONG FlsBitmapBits[FLS_MAXIMUM_AVAILABLE / (<span class="keyword">sizeof</span>(ULONG) * <span class="number">8</span>)]; <span class="comment">// Offset: 0x408</span></span><br><span class="line">    ULONG FlsHighIndex;                          <span class="comment">// Offset: 0x448</span></span><br><span class="line">    PVOID WerRegistrationData;                   <span class="comment">// Offset: 0x450</span></span><br><span class="line">    PVOID WerShipAssertPtr;                      <span class="comment">// Offset: 0x458</span></span><br><span class="line">    PVOID pContextData;                          <span class="comment">// Offset: 0x460</span></span><br><span class="line">    PVOID pImageHeaderHash;                      <span class="comment">// Offset: 0x468</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        ULONG TracingFlags;                      <span class="comment">// Offset: 0x470</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG HeapTracingEnabled : <span class="number">1</span>;        <span class="comment">// Offset: 0x470</span></span><br><span class="line">            ULONG CriticalSectionTracingEnabled : <span class="number">1</span>; <span class="comment">// Offset: 0x470</span></span><br><span class="line">            ULONG LibraryTracingEnabled : <span class="number">1</span>;     <span class="comment">// Offset: 0x470</span></span><br><span class="line">            ULONG reserved : <span class="number">29</span>;                 <span class="comment">// Offset: 0x470</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONGLONG CsrServerReadOnlySharedMemoryBase; <span class="comment">// Offset: 0x478</span></span><br><span class="line">&#125; PEB, *PPEB;</span><br></pre></td></tr></table></figure>

<p>偏移0x18处找到Ldr</p>
<p>PPEB_LDR_DATA结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span> &#123;</span></span><br><span class="line">    ULONG Length;                                <span class="comment">// 0x000</span></span><br><span class="line">    BOOLEAN Initialized;                        <span class="comment">// 0x004</span></span><br><span class="line">    PVOID SsHandle;                             <span class="comment">// 0x008</span></span><br><span class="line">    LIST_ENTRY InLoadOrderModuleList;           <span class="comment">// 0x010</span></span><br><span class="line">    LIST_ENTRY InMemoryOrderModuleList;         <span class="comment">// 0x020</span></span><br><span class="line">    LIST_ENTRY InInitializationOrderModuleList; <span class="comment">// 0x030</span></span><br><span class="line">    PVOID EntryInProgress;                      <span class="comment">// 0x040</span></span><br><span class="line">    BOOLEAN ShutdownInProgress;                 <span class="comment">// 0x048</span></span><br><span class="line">    HANDLE ShutdownThreadId;                    <span class="comment">// 0x050</span></span><br><span class="line">&#125; PEB_LDR_DATA, *PPEB_LDR_DATA;</span><br></pre></td></tr></table></figure>

<p>​<code>LIST_ENTRY InLoadOrderModuleList;           // 按照加载顺序组织的模块链表</code>​<br>​<code>LIST_ENTRY InMemoryOrderModuleList;         // 按照内存地址顺序组织的模块链表</code>​</p>
<p>​<code>LIST_ENTRY InInitializationOrderModuleList; // 按照初始化顺序组织的模块链表</code>​</p>
<p>‍</p>
<p>LIST_ENTRY结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> *<span class="title">Flink</span>;</span>		<span class="comment">//0x00</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> *<span class="title">Blink</span>;</span>		<span class="comment">//0x04</span></span><br><span class="line">&#125; LIST_ENTRY, *PLIST_ENTRY;</span><br></pre></td></tr></table></figure>

<p>​<code>Flink</code>​: 指向下一个链表节点的指针</p>
<p>​<code>Blink</code>​: 指向上一个链表节点的指针</p>
<p>可以看出来是个双向链表，这个结构体中的<code>Flink</code>​指向真正的模块链表，而模块链表的每一个成员都是一个<code>LDR_DATA_TABLE_ENTRY</code>​结构</p>
<p>‍</p>
<p>​<code>_LDR_DATA_TABLE_ENTRY</code>​结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">    LIST_ENTRY InLoadOrderLinks;    <span class="comment">// 0x00 - 链接到加载顺序双向链表</span></span><br><span class="line">    LIST_ENTRY InMemoryOrderLinks;  <span class="comment">// 0x10 - 链接到内存地址顺序双向链表</span></span><br><span class="line">    LIST_ENTRY InInitializationOrderLinks; <span class="comment">// 0x20 - 链接到初始化顺序双向链表</span></span><br><span class="line">    PVOID DllBase;                  <span class="comment">// 0x30 - DLL基地址</span></span><br><span class="line">    PVOID EntryPoint;               <span class="comment">// 0x38 - DLL入口点</span></span><br><span class="line">    ULONG SizeOfImage;              <span class="comment">// 0x40 - DLL映像大小</span></span><br><span class="line">    UNICODE_STRING FullDllName;     <span class="comment">// 0x48 - 完整DLL名称</span></span><br><span class="line">    UNICODE_STRING BaseDllName;     <span class="comment">// 0x60 - 基本DLL名称</span></span><br><span class="line">    ULONG Flags;                    <span class="comment">// 0x78 - 标志位</span></span><br><span class="line">    USHORT LoadCount;               <span class="comment">// 0x7C - 加载计数</span></span><br><span class="line">    USHORT TlsIndex;                <span class="comment">// 0x7E - TLS索引</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        LIST_ENTRY HashLinks;       <span class="comment">// 0x80 - 哈希链表链接</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PVOID SectionPointer;   <span class="comment">// 0x80 - 内存映射指针</span></span><br><span class="line">            ULONG CheckSum;         <span class="comment">// 0x88 - 校验和</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        ULONG TimeDateStamp;        <span class="comment">// 0x90 - 时间戳</span></span><br><span class="line">        PVOID LoadedImports;        <span class="comment">// 0x90 - 已加载的导入模块</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125; LDR_DATA_TABLE_ENTRY, *PLDR_DATA_TABLE_ENTRY;</span><br></pre></td></tr></table></figure>

<p>PEB中链表的<strong>Flink</strong>指向 <strong>_LDR_DATA_TABLE_ENTRY</strong>结构体</p>
<p>​<img src="/../imge/dll%E5%8A%A0%E8%BD%BD/assets/image-20240807220505-gos0xhf.png" alt="image" loading="lazy">​</p>
<p>(借了大佬一张图）</p>
<p>具体实现就不写了，不太会写，让chat生成了一个</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span> &#123;</span></span><br><span class="line">    ULONG Length;</span><br><span class="line">    BOOLEAN Initialized;</span><br><span class="line">    PVOID SsHandle;</span><br><span class="line">    LIST_ENTRY InLoadOrderModuleList;</span><br><span class="line">    LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">    LIST_ENTRY InInitializationOrderModuleList;</span><br><span class="line">&#125; PEB_LDR_DATA, *PPEB_LDR_DATA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span> &#123;</span></span><br><span class="line">    BOOLEAN InheritedAddressSpace;</span><br><span class="line">    BOOLEAN ReadImageFileExecOptions;</span><br><span class="line">    BOOLEAN BeingDebugged;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        BOOLEAN BitField;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            BOOLEAN ImageUsesLargePages : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsProtectedProcess : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsImageDynamicallyRelocated : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN SkipPatchingUser32Forwarders : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsPackagedProcess : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsAppContainer : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsProtectedProcessLight : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsLongPathAwareProcess : <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    HANDLE Mutant;</span><br><span class="line">    PVOID ImageBaseAddress;</span><br><span class="line">    PPEB_LDR_DATA Ldr;</span><br><span class="line">    <span class="comment">// ... (other fields omitted)</span></span><br><span class="line">&#125; PEB, *PPEB;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    PPEB pPeb;</span><br><span class="line">    PPEB_LDR_DATA pLdr;</span><br><span class="line">    PLIST_ENTRY pListEntry;</span><br><span class="line">    PLDR_DATA_TABLE_ENTRY pModuleEntry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取进程环境块 (PEB)</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov rax, gs:[<span class="number">0x60</span>]</span><br><span class="line">        mov pPeb, rax</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 PEB 的 Ldr 字段</span></span><br><span class="line">    pLdr = pPeb-&gt;Ldr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历 Ldr 的 InLoadOrderModuleList 链表</span></span><br><span class="line">    pListEntry = pLdr-&gt;InLoadOrderModuleList.Flink;</span><br><span class="line">    <span class="keyword">while</span> (pListEntry != &amp;pLdr-&gt;InLoadOrderModuleList) &#123;</span><br><span class="line">        pModuleEntry = CONTAINING_RECORD(pListEntry, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出模块名称</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Module: %ws\n&quot;</span>, pModuleEntry-&gt;BaseDllName.Buffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载 DLL</span></span><br><span class="line">        HMODULE hModule = LoadLibraryW(pModuleEntry-&gt;BaseDllName.Buffer);</span><br><span class="line">        <span class="keyword">if</span> (hModule) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Loaded DLL: %p\n&quot;</span>, hModule);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to load DLL: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pListEntry = pListEntry-&gt;Flink;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<h3 id="遍历-PEB-的模块链表加载dll的优缺点"><a href="#遍历-PEB-的模块链表加载dll的优缺点" class="headerlink" title="遍历 PEB 的模块链表加载dll的优缺点"></a>遍历 PEB 的模块链表加载dll的优缺点</h3><p>优：</p>
<ul>
<li>无需手动编写加载和卸载 DLL 的代码,可以自动加载所需的 DLL。</li>
<li>可以在不知道 DLL 文件路径的情况下加载 DLL。</li>
<li>可以避免 DLL 文件不存在或无法访问导致的应用程序崩溃。</li>
</ul>
<p>缺：</p>
<ul>
<li>实现相对复杂,需要了解 PEB 的结构和遍历模块链表的方法。</li>
<li>可能无法检测到某些 DLL 的加载状态,比如动态加载的 DLL。</li>
<li>需要处理 DLL 依赖关系和版本兼容性问题。</li>
<li>可能无法提供与 Windows API 调用 DLL 相同的灵活性和控制力。</li>
</ul>
<p>‍</p>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">I'm so cute. Please give me money.</div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>YCr0w</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://example.com/2024/08/07/%E5%8A%A0%E8%BD%BD%E7%89%B9%E5%AE%9A%E6%A8%A1%E5%9D%97%E7%9A%84%E6%96%B9%E6%B3%95/" title="加载特定模块的方法">http://example.com/2024/08/07/%E5%8A%A0%E8%BD%BD%E7%89%B9%E5%AE%9A%E6%A8%A1%E5%9D%97%E7%9A%84%E6%96%B9%E6%B3%95/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2024/08/08/pikabot/" rel="prev" title="pikabot"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">pikabot</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/08/07/CobaltStrike%E5%8A%A8%E8%B0%83/" rel="next" title="CobaltStrike动调"><span class="post-nav-text">CobaltStrike动调</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2024 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> YCr0w</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>